<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Ledger - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; 
            padding: 20px; 
            color: #333;
        }
        .report-container {
            width: 100%;
            /* Removed max-width to allow it to fill 100% of the screen */
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .controls input[type="text"], .controls select {
            padding: 8px;
            width: 45%;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .controls button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .controls button:hover {
            background-color: #002244;
        }
        .filter-section {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* New Wrapper for controlled horizontal scrolling */
        .table-wrapper {
            overflow-x: auto; /* Allows only the table to scroll, not the whole page */
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            /* Removed table-layout: fixed; for better flow on small screens */
            min-width: 750px; /* Minimum width to ensure columns don't collapse */
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px 4px; 
            text-align: left;
            font-size: 12px; 
        }
        th {
            background-color: #f2f2f2;
        }
        
        /* General column widths for desktop (approximate for flow) */
        #ledger-table th:nth-child(1), #ledger-table td:nth-child(1) { width: 10%; } /* Date */
        #ledger-table th:nth-child(2), #ledger-table td:nth-child(2) { width: 20%; } /* Account */
        #ledger-table th:nth-child(3), #ledger-table td:nth-child(3) { 
            width: 30%; /* Description */
            word-wrap: break-word; 
        } 
        #ledger-table th:nth-child(4), #ledger-table td:nth-child(4) { width: 8%; } /* Doc # */
        #ledger-table th:nth-child(5), #ledger-table td:nth-child(5) { width: 10%; } /* Debit */
        #ledger-table th:nth-child(6), #ledger-table td:nth-child(6) { width: 10%; } /* Credit */
        #ledger-table th:nth-child(7), #ledger-table td:nth-child(7) { width: 12%; } /* Balance */


        tfoot td {
            font-weight: bold;
            background-color: #e6e6ff;
        }
        .debit-amount, .credit-amount, .balance-column {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .balance-column {
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #003366;
        }
        .doc-link {
            color: #003366;
            text-decoration: underline;
            cursor: pointer;
        }
        .doc-link:hover {
            color: #002244;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .controls input[type="text"], .controls select {
                width: 100%;
            }
            .filter-section {
                flex-direction: column;
            }
            .controls button {
                width: 45%;
            }
            /* INCREASED FONT SIZE (FIX) */
            table, th, td {
                font-size: 11px;
                padding: 3px;
            }
            
            /* Remove fixed widths on mobile to prevent overlapping, 
               relying on min-width and overflow-x on the wrapper */
            #ledger-table th:nth-child(1), #ledger-table td:nth-child(1) { width: auto; }
            #ledger-table th:nth-child(2), #ledger-table td:nth-child(2) { width: auto; }
            #ledger-table th:nth-child(3), #ledger-table td:nth-child(3) { width: auto; }
            #ledger-table th:nth-child(4), #ledger-table td:nth-child(4) { width: auto; }
            #ledger-table th:nth-child(5), #ledger-table td:nth-child(5) { width: auto; }
            #ledger-table th:nth-child(6), #ledger-table td:nth-child(6) { width: auto; }
            #ledger-table th:nth-child(7), #ledger-table td:nth-child(7) { width: auto; }

        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading ledger data...</div>
    <div class="report-container" style="display: none;" id="mainContent">
        <div class="header">
            <h1>General Ledger Report</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>

        <div class="controls">
            <div class="filter-section">
                <input type="text" id="search-bar" placeholder="Search by account name or description...">
                <select id="account-filter">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div>
                <button onclick="filterLedger()">Filter</button>
                <button onclick="resetLedger()">Show All</button>
                <button onclick="generatePDF()">Generate PDF</button>
                <button onclick="window.location.href='documents.html'">Back to Documents</button>
            </div>
        </div>

        <h3 id="current-ledger-title" style="text-align: center;">All Transactions</h3>
        
        <div class="table-wrapper">
            <table id="ledger-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Account</th>
                        <th>Description</th>
                        <th>Doc #</th>
                        <th>Debit (Rs.)</th>
                        <th>Credit (Rs.)</th>
                        <th class="balance-column">Balance (Rs.)</th>
                    </tr>
                </thead>
                <tbody id="ledger-body">
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">Total</td>
                        <td id="total-debit" class="debit-amount">0</td>
                        <td id="total-credit" class="credit-amount">0</td>
                        <td class="balance-column" id="final-balance">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // IMPORTANT: Replace this with your actual Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCm_tjninuNgd11f0c4t6Qy9eDrq4KaCD4",
            authDomain: "bet-acc-software.firebaseapp.com",
            projectId: "bet-acc-software",
            storageBucket: "bet-acc-software.firebasestorage.app",
            messagingSenderId: "879522152449",
            appId: "1:879522152449:web:73b8ef899d5c1cbfd90000"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allLedgerEntries = [];
        let uniqueAccounts = new Set();

        function parseDate(dateStr) {
            // Parses DD-MM-YYYY format
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        async function loadLedgerData() {
            try {
                const ledgerQuery = query(collection(db, "ledger"));
                const snapshot = await getDocs(ledgerQuery);
                
                allLedgerEntries = [];
                uniqueAccounts.clear();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allLedgerEntries.push(data);
                    if (data.account) {
                        uniqueAccounts.add(data.account);
                    }
                });

                // Sort by date then by timestamp (if available, for tie-breaking)
                allLedgerEntries.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    if (dateA - dateB !== 0) return dateA - dateB;
                    // Fallback to timestamp for stable order on the same day
                    return (a.timestamp || '').localeCompare(b.timestamp || '');
                });
                
                populateAccountFilter();
                displayLedger(allLedgerEntries);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error("Error loading ledger:", error);
                document.getElementById('loading').innerHTML = 'Error loading ledger data. Please refresh the page.';
            }
        }

        function populateAccountFilter() {
            const accountFilter = document.getElementById('account-filter');
            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            
            const sortedAccounts = Array.from(uniqueAccounts).sort();
            sortedAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
        }

        function displayLedger(entries) {
            const ledgerBody = document.getElementById('ledger-body');
            let totalDebit = 0;
            let totalCredit = 0;
            let runningBalance = 0;
            ledgerBody.innerHTML = '';

            entries.forEach(entry => {
                const row = ledgerBody.insertRow();
                // Ensure debit/credit are numbers
                const debit = parseFloat(entry.debit || 0);
                const credit = parseFloat(entry.credit || 0);
                
                // Balance calculation: Debit (increase) - Credit (decrease)
                runningBalance += (debit - credit);

                // Determine if a link exists based on doc_number
                const docNumber = entry.doc_number || '';
                const docCellContent = docNumber ? 
                    `<span class="doc-link" onclick="window.viewDocument('${docNumber}')">${docNumber}</span>` : 
                    'N/A';

                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.account || 'N/A'}</td>
                    <td>${entry.description || ''}</td>
                    <td>${docCellContent}</td>
                    <td class="debit-amount">${debit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="credit-amount">${credit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="balance-column">${runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                `;
                totalDebit += debit;
                totalCredit += credit;
            });
            
            document.getElementById('total-debit').textContent = totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('total-credit').textContent = totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('final-balance').textContent = runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function filterLedger() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase().trim();
            const accountName = document.getElementById('account-filter').value;

            let filteredEntries = allLedgerEntries;

            if (searchTerm) {
                filteredEntries = filteredEntries.filter(entry => 
                    (entry.account && entry.account.toLowerCase().includes(searchTerm)) ||
                    (entry.description && entry.description.toLowerCase().includes(searchTerm)) ||
                    (entry.doc_number && entry.doc_number.toLowerCase().includes(searchTerm))
                );
            }

            if (accountName) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.account === accountName
                );
            }

            let titleText = 'All Transactions';
            if (searchTerm && accountName) {
                titleText = `Account: ${accountName} | Search: ${searchTerm.toUpperCase()}`;
            } else if (searchTerm) {
                titleText = `Search: ${searchTerm.toUpperCase()}`;
            } else if (accountName) {
                titleText = `Account: ${accountName}`;
            }

            document.getElementById('current-ledger-title').textContent = titleText;
            displayLedger(filteredEntries);
        }

        function resetLedger() {
            document.getElementById('search-bar').value = '';
            document.getElementById('account-filter').value = '';
            document.getElementById('current-ledger-title').textContent = 'All Transactions';
            displayLedger(allLedgerEntries);
        }

        /**
         * Determines the document type and redirects based on the doc_number prefix.
         * This avoids multiple slow database lookups.
         */
        function viewDocument(docNumber) {
            if (!docNumber) return;
            
            let targetURL = '';
            
            // Normalize case for comparison
            const prefix = docNumber.toUpperCase().split('-')[0];

            // --- Your Document Prefix Conventions ---
            // Note: The file names below are assumed to be your actual document edit pages
            if (docNumber.startsWith('CR-')) {
                // Customer Receipt (Collection: customerReceipts -> File: customer-receipt.html)
                targetURL = `customer-receipt.html?edit=${docNumber}`;
            } else if (docNumber.startsWith('VP-')) {
                // Vendor Payment (Collection: vendorPayments -> File: vendor-payment-receipt.html)
                targetURL = `vendor-payment-receipt.html?edit=${docNumber}`;
            } else if (docNumber.startsWith('SI-')) {
                // Sales Invoice (Collection: salesInvoices -> File: sales-invoice.html OR invoice.html)
                targetURL = `invoice.html?edit=${docNumber}`;
            } else if (docNumber.startsWith('PI-')) {
                // Purchase Invoice (Collection: purchaseInvoices -> File: purchase-invoice.html)
                targetURL = `purchase-invoice.html?edit=${docNumber}`;
            } else if (docNumber.startsWith('JE-')) {
                // Journal Entry (Collection: journalEntries -> File: journal-entry.html)
                targetURL = `journal-entry.html?edit=${docNumber}`;
            } 
            // Handle the legacy/simple 4-digit number convention (e.g., 00100)
            else if (!isNaN(parseInt(docNumber)) && docNumber.length <= 4) {
                 // Fallback: This block handles older documents that might not have a prefix.
                 // Since we can't reliably guess, we give a warning.
                 alert("Ambiguous document number (no prefix). Please navigate manually. We recommend using prefixes (SI-, CR-, VP-, PI-) for all new documents.");
                 return;
            } else {
                alert(`Unrecognized document prefix: ${prefix}. Cannot automatically open the file.`);
                return;
            }
            
            if (targetURL) {
                window.location.href = targetURL;
            }
        }

        function generatePDF() {
            const title = document.getElementById('current-ledger-title').textContent;
            
            let pdfContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2 style="text-align: center; color: #003366;">General Ledger Report</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: #003366;">(BET) Bilal Ehtasham Traders</h3>
                        <p>Deals in all kinds of Cotton and Polyester Yarn</p>
                    </div>
                    <p><strong>Report:</strong> ${title}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="border: 1px solid #ccc; padding: 8px;">Date</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Account</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Description</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Doc #</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Debit</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Credit</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const rows = document.querySelectorAll('#ledger-body tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                pdfContent += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[0].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[1].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[2].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[3].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[4].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[5].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[6].textContent}</td>
                    </tr>
                `;
            });

            const totalDebit = document.getElementById('total-debit').textContent;
            const totalCredit = document.getElementById('total-credit').textContent;
            const finalBalance = document.getElementById('final-balance').textContent;

            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #e6e6ff; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #ccc; padding: 8px;">TOTAL</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${totalDebit}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${totalCredit}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${finalBalance}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        document.addEventListener('DOMContentLoaded', loadLedgerData);

        // Expose functions to the global scope for inline onclick events
        window.filterLedger = filterLedger;
        window.resetLedger = resetLedger;
        window.generatePDF = generatePDF;
        window.viewDocument = viewDocument;
    </script>
</body>
</html>
