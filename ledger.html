<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Ledger - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .report-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .controls input[type="text"] {
            padding: 8px;
            width: 50%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .controls button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tfoot td {
            font-weight: bold;
            background-color: #e6e6ff; /* Highlight totals */
        }
        .debit-amount, .credit-amount {
            text-align: right;
        }
        /* New: for running balance */
        .balance-column {
            text-align: right;
            font-weight: bold;
            width: 15%;
        }
    </style>
</head>
<body>
    <script src="data.js"></script>
    <div class="report-container">
        <div class="header">
            <h1>General Ledger Report</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>

        <div class="controls">
            <input type="text" id="search-bar" placeholder="Search by customer or vendor name...">
            <button onclick="filterLedger()">Search</button>
            <button onclick="resetLedger()">Show All</button>
            <button onclick="generatePDF()">Generate PDF</button>
        </div>

        <h3 id="current-ledger-title" style="text-align: center;">All Transactions</h3>
        
        <table id="ledger-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Debit (Rs.)</th>
                    <th>Credit (Rs.)</th>
                    <th class="balance-column">Balance (Rs.)</th>
                </tr>
            </thead>
            <tbody id="ledger-body">
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">Total</td>
                    <td id="total-debit" class="debit-amount">0</td>
                    <td id="total-credit" class="credit-amount">0</td>
                    <td class="balance-column" id="final-balance">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // NOTE: Assume 'ledger' array is loaded globally by data.js
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Uncomment loadData() when integrating with data.js
            // loadData(); 
            displayLedger(ledger);
        });

        function displayLedger(entries) {
            const ledgerBody = document.getElementById('ledger-body');
            let totalDebit = 0;
            let totalCredit = 0;
            let runningBalance = 0;
            ledgerBody.innerHTML = '';
            
            // Sort entries by date (assuming entry.date is sortable or can be parsed)
            entries.sort((a, b) => new Date(a.date.split('-').reverse().join('/')) - new Date(b.date.split('-').reverse().join('/')));


            entries.forEach(entry => {
                const row = ledgerBody.insertRow();
                const debit = entry.debit || 0;
                const credit = entry.credit || 0;
                
                // For a General Ledger, Balance = Opening Balance + Debit - Credit 
                // (This is standard for Asset/Expense Accounts. For Liability/Revenue, it would be - Debit + Credit)
                // Since this is a combined ledger, we will use a simple Debit-Credit balance for illustration.
                runningBalance += (debit - credit);

                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.description}</td>
                    <td class="debit-amount">${debit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="credit-amount">${credit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="balance-column">${runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                `;
                totalDebit += debit;
                totalCredit += credit;
            });
            document.getElementById('total-debit').textContent = totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('total-credit').textContent = totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('final-balance').textContent = runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function filterLedger() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase().trim();
            if (!searchTerm) {
                resetLedger();
                return;
            }

            // Enhanced filtering: Look for the party name in description OR accountType
            const filteredEntries = ledger.filter(entry => 
                entry.description.toLowerCase().includes(searchTerm) ||
                (entry.accountType && entry.accountType.toLowerCase().includes(searchTerm))
            );
            
            document.getElementById('current-ledger-title').textContent = `Ledger for: ${searchTerm.toUpperCase()}`;
            displayLedger(filteredEntries);
        }

        function resetLedger() {
            document.getElementById('search-bar').value = '';
            document.getElementById('current-ledger-title').textContent = 'All Transactions';
            displayLedger(ledger);
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');

            const searchTerm = document.getElementById('search-bar').value || "All Transactions";
            
            // Header Info
            doc.setFontSize(14);
            doc.setTextColor(0, 51, 102); // #003366
            doc.text("(BET) Bilal Ehtasham Traders - General Ledger", 40, 40);
            
            doc.setFontSize(12);
            doc.setTextColor(51, 51, 51); // #333
            doc.text(`Report for: ${document.getElementById('current-ledger-title').textContent}`, 40, 60);
            doc.text(`Date Generated: ${new Date().toLocaleDateString('en-GB')}`, 400, 60);

            // Table Data (autoTable handles the structure and totals)
            doc.autoTable({
                html: '#ledger-table',
                startY: 80,
                theme: 'striped',
                headStyles: { fillColor: [242, 242, 242], textColor: [0, 0, 0] },
                footStyles: { fillColor: [230, 230, 255], fontStyle: 'bold' }, // #e6e6ff
                styles: { fontSize: 10, cellPadding: 5 },
                columnStyles: {
                    // Right-align debit, credit, and balance columns
                    2: { halign: 'right' },
                    3: { halign: 'right' },
                    4: { halign: 'right' }, 
                },
                didDrawPage: function (data) {
                    // Footer branding
                    doc.setFontSize(8);
                    doc.text("Email: bilalehtashamtraders@gmail.com | Cell: (+92)-324-2479096", data.settings.margin.left, doc.internal.pageSize.height - 20);
                }
            });

            doc.save(`Ledger_Report_${searchTerm.replace(/ /g, '_')}.pdf`);
        }
    </script>
</body>
</html>
