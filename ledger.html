<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Ledger - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .report-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .controls input[type="text"], .controls select {
            padding: 8px;
            width: 45%;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .controls button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .controls button:hover {
            background-color: #002244;
        }
        .filter-section {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tfoot td {
            font-weight: bold;
            background-color: #e6e6ff;
        }
        .debit-amount, .credit-amount, .balance-column {
            text-align: right;
        }
        .balance-column {
            font-weight: bold;
            width: 15%;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #003366;
        }
        .doc-link {
            color: #003366;
            text-decoration: underline;
            cursor: pointer;
        }
        .doc-link:hover {
            color: #002244;
        }

        @media (max-width: 600px) {
            .controls input[type="text"], .controls select {
                width: 90%;
            }
            table, th, td {
                font-size: 10px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading ledger data...</div>
    <div class="report-container" style="display: none;" id="mainContent">
        <div class="header">
            <h1>General Ledger Report</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>

        <div class="controls">
            <div class="filter-section">
                <input type="text" id="search-bar" placeholder="Search by account name or description...">
                <select id="account-filter">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div>
                <button onclick="filterLedger()">Filter</button>
                <button onclick="resetLedger()">Show All</button>
                <button onclick="generatePDF()">Generate PDF</button>
                <button onclick="window.location.href='documents.html'">Back to Documents</button>
            </div>
        </div>

        <h3 id="current-ledger-title" style="text-align: center;">All Transactions</h3>
        
        <table id="ledger-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Doc #</th>
                    <th>Debit (Rs.)</th>
                    <th>Credit (Rs.)</th>
                    <th class="balance-column">Balance (Rs.)</th>
                </tr>
            </thead>
            <tbody id="ledger-body">
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4">Total</td>
                    <td id="total-debit" class="debit-amount">0</td>
                    <td id="total-credit" class="credit-amount">0</td>
                    <td class="balance-column" id="final-balance">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCm_tjninuNgd11f0c4t6Qy9eDrq4KaCD4",
            authDomain: "bet-acc-software.firebaseapp.com",
            projectId: "bet-acc-software",
            storageBucket: "bet-acc-software.firebasestorage.app",
            messagingSenderId: "879522152449",
            appId: "1:879522152449:web:73b8ef899d5c1cbfd90000"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allLedgerEntries = [];
        let uniqueAccounts = new Set();

        function parseDate(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        async function loadLedgerData() {
            try {
                const ledgerQuery = query(collection(db, "ledger"));
                const snapshot = await getDocs(ledgerQuery);
                
                allLedgerEntries = [];
                uniqueAccounts.clear();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allLedgerEntries.push(data);
                    if (data.account) {
                        uniqueAccounts.add(data.account);
                    }
                });

                allLedgerEntries.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                
                populateAccountFilter();
                displayLedger(allLedgerEntries);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error("Error loading ledger:", error);
                document.getElementById('loading').innerHTML = 'Error loading ledger data. Please refresh the page.';
            }
        }

        function populateAccountFilter() {
            const accountFilter = document.getElementById('account-filter');
            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            
            const sortedAccounts = Array.from(uniqueAccounts).sort();
            sortedAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
        }

        function displayLedger(entries) {
            const ledgerBody = document.getElementById('ledger-body');
            let totalDebit = 0;
            let totalCredit = 0;
            let runningBalance = 0;
            ledgerBody.innerHTML = '';

            entries.forEach(entry => {
                const row = ledgerBody.insertRow();
                const debit = entry.debit || 0;
                const credit = entry.credit || 0;
                
                runningBalance += (debit - credit);

                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.account || 'N/A'}</td>
                    <td>${entry.description || ''}</td>
                    <td><span class="doc-link" onclick="window.viewDocument('${entry.doc_number}')">${entry.doc_number}</span></td>
                    <td class="debit-amount">${debit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="credit-amount">${credit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="balance-column">${runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                `;
                totalDebit += debit;
                totalCredit += credit;
            });
            
            document.getElementById('total-debit').textContent = totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('total-credit').textContent = totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('final-balance').textContent = runningBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function filterLedger() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase().trim();
            const accountName = document.getElementById('account-filter').value;

            let filteredEntries = allLedgerEntries;

            if (searchTerm) {
                filteredEntries = filteredEntries.filter(entry => 
                    (entry.account && entry.account.toLowerCase().includes(searchTerm)) ||
                    (entry.description && entry.description.toLowerCase().includes(searchTerm)) ||
                    (entry.doc_number && entry.doc_number.toLowerCase().includes(searchTerm))
                );
            }

            if (accountName) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.account === accountName
                );
            }

            let titleText = 'All Transactions';
            if (searchTerm && accountName) {
                titleText = `${accountName} - ${searchTerm.toUpperCase()}`;
            } else if (searchTerm) {
                titleText = `Search: ${searchTerm.toUpperCase()}`;
            } else if (accountName) {
                titleText = `Account: ${accountName}`;
            }

            document.getElementById('current-ledger-title').textContent = titleText;
            displayLedger(filteredEntries);
        }

        function resetLedger() {
            document.getElementById('search-bar').value = '';
            document.getElementById('account-filter').value = '';
            document.getElementById('current-ledger-title').textContent = 'All Transactions';
            displayLedger(allLedgerEntries);
        }

        async function viewDocument(docNumber) {
            if (!docNumber) return;
            
            try {
                if (docNumber.startsWith('JE-')) {
                    window.location.href = `journal-entry.html?edit=${docNumber}`;
                } else if (docNumber.startsWith('CR-') || docNumber.startsWith('00')) {
                    const receiptRef = await getDocs(collection(db, "customerReceipts"));
                    let found = false;
                    
                    receiptRef.forEach(doc => {
                        if (doc.data().number === docNumber) {
                            found = true;
                            window.location.href = `receipt.html?edit=${docNumber}`;
                        }
                    });
                    
                    if (!found) {
                        const salesRef = await getDocs(collection(db, "salesInvoices"));
                        salesRef.forEach(doc => {
                            if (doc.data().number === docNumber) {
                                found = true;
                                window.location.href = `invoice.html?edit=${docNumber}`;
                            }
                        });
                    }
                    
                    if (!found) {
                        alert('Document not found.');
                    }
                } else if (docNumber.startsWith('VP-')) {
                    window.location.href = `vendor-payment-receipt.html?edit=${docNumber}`;
                } else {
                    const purchaseRef = await getDocs(collection(db, "purchaseInvoices"));
                    let found = false;
                    
                    purchaseRef.forEach(doc => {
                        if (doc.data().number === docNumber) {
                            found = true;
                            window.location.href = `purchase-invoice.html?edit=${docNumber}`;
                        }
                    });
                    
                    if (!found) {
                        alert('Document not found.');
                    }
                }
            } catch (error) {
                console.error("Error viewing document:", error);
                alert('Error loading document.');
            }
        }

        function generatePDF() {
            const title = document.getElementById('current-ledger-title').textContent;
            
            let pdfContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2 style="text-align: center; color: #003366;">General Ledger Report</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: #003366;">(BET) Bilal Ehtasham Traders</h3>
                        <p>Deals in all kinds of Cotton and Polyester Yarn</p>
                    </div>
                    <p><strong>Report:</strong> ${title}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="border: 1px solid #ccc; padding: 8px;">Date</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Account</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Description</th>
                                <th style="border: 1px solid #ccc; padding: 8px;">Doc #</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Debit</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Credit</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const rows = document.querySelectorAll('#ledger-body tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                pdfContent += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[0].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[1].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[2].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px;">${cells[3].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[4].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[5].textContent}</td>
                        <td style="border: 1px solid #ccc; padding: 5px; text-align: right;">${cells[6].textContent}</td>
                    </tr>
                `;
            });

            const totalDebit = document.getElementById('total-debit').textContent;
            const totalCredit = document.getElementById('total-credit').textContent;
            const finalBalance = document.getElementById('final-balance').textContent;

            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #e6e6ff; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #ccc; padding: 8px;">TOTAL</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${totalDebit}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${totalCredit}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${finalBalance}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        document.addEventListener('DOMContentLoaded', loadLedgerData);

        window.filterLedger = filterLedger;
        window.resetLedger = resetLedger;
        window.generatePDF = generatePDF;
        window.viewDocument = viewDocument;
    </script>
</body>
</html>