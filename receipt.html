<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Payment - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .receipt-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .details-table td {
            padding: 8px 0;
            font-size: 14px;
        }
        .details-table .label {
            font-weight: bold;
            width: 150px;
        }
        .editable-field {
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
            width: calc(100% - 160px);
            padding: 2px 0;
            background: transparent;
        }
        #amount-in-words-container {
            width: calc(100% - 100px);
        }
        #amount-in-words {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
            background: transparent;
        }
        .amount-section {
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .amount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .amount-row .label {
            font-weight: bold;
        }
        .calculated-value {
            font-weight: bold;
        }
        button {
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            background-color: #003366;
            color: white;
            border: none;
        }
        .payment-method {
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .input-group input {
            /* Input must have flexible width for the layout */
            flex-grow: 1; 
            text-align: right;
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
        }
        .input-group .suffix {
            margin-left: 5px;
            font-weight: bold;
        }
        .input-group span:first-child {
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <script src="data.js"></script>
    <div class="receipt-container">
        <div class="header">
            <h1>PAYMENT FROM CUSTOMER</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>
    
        <table class="details-table">
            <tr>
                <td class="label">Receipt No:</td>
                <td><input type="text" class="editable-field" id="receipt-no" placeholder="e.g., 00156" readonly></td>
            </tr>
            <tr>
                <td class="label">Date:</td>
                <td><input type="text" class="editable-field" id="receipt-date" placeholder="e.g., 27-09-2025"></td>
            </tr>
            <tr>
                <td class="label">Received from:</td>
                <td><input type="text" class="editable-field" id="received-from" placeholder="e.g., Altaf Bhai"></td>
            </tr>
            <tr>
                <td class="label">Business (Ledger):</td>
                <td><input type="text" class="editable-field" id="business-ledger" placeholder="e.g., Kohinoor Fashion"></td>
            </tr>
        </table>
    
        <div class="payment-method">
            <label for="paymentMethod">Payment Method:</label>
            <select id="paymentMethod">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
            </select>
        </div>
    
        <table class="details-table">
            <tr>
                <td class="label">Previous Balance:</td>
                <td>
                    <div class="input-group">
                        <span>PKR:</span>
                        <input type="text" id="previous-balance" style="width: 100%;">
                        <span class="suffix">/=</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label">Cheque/Online Ref:</td>
                <td><input type="text" class="editable-field" id="cheque-ref" placeholder="e.g., 344151"></td>
            </tr>
            <tr>
                <td class="label">Cheque/Bank name:</td>
                <td><input type="text" class="editable-field" id="cheque-bank" placeholder="e.g., Meezan Bank"></td>
            </tr>
            <tr>
                <td class="label">Account Title:</td>
                <td><input type="text" class="editable-field" id="account-title" placeholder="e.g., Bilal Ehtasham"></td>
            </tr>
        </table>
    
        <div class="amount-section">
            <div class="amount-row">
                <span class="label">Amount received:</span>
                <div class="input-group">
                    <span>PKR:</span>
                    <input type="text" id="amount-received" style="width: 100%;">
                    <span class="suffix">/=</span>
                </div>
            </div>
            <div class="amount-row">
                <span class="label">In Words:</span>
                <span id="amount-in-words-container">
                    <input type="text" id="amount-in-words" placeholder="e.g., Fifty seven thousand only" readonly>
                </span>
            </div>
        </div>
    
        <div class="amount-section">
            <div class="amount-row">
                <span class="label">Account Receivable:</span>
                <span class="calculated-value" id="account-receivable">PKR: 0/=</span>
            </div>
        </div>
    </div>
    
    <button onclick="savePayment()">Save Payment</button>
    <button onclick="generatePDF()">Generate PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        let isEditing = false;
        let originalDocNumber = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const docToEdit = JSON.parse(localStorage.getItem('docToEdit'));
            if (docToEdit) {
                populateForm(docToEdit);
                isEditing = true;
                originalDocNumber = docToEdit.number;
                localStorage.removeItem('docToEdit');
            } else {
                document.getElementById('receipt-no').value = '00' + (++lastReceiptNumber);
                document.getElementById('receipt-date').value = new Date().toLocaleDateString('en-GB');
            }
            
            // Attach the function to both inputs
            document.getElementById('previous-balance').addEventListener('input', formatAndCalculate);
            document.getElementById('amount-received').addEventListener('input', formatAndCalculate);
            calculateAccountReceivable();
        });

        function populateForm(doc) {
            document.getElementById('receipt-no').value = doc.number;
            document.getElementById('receipt-date').value = doc.date;
            document.getElementById('received-from').value = doc.receivedFrom;
            document.getElementById('business-ledger').value = doc.businessLedger;
            document.getElementById('paymentMethod').value = doc.paymentMethod;
            
            // Set values as formatted strings
            document.getElementById('previous-balance').value = (doc.previousBalance || 0).toLocaleString('en-US');
            document.getElementById('cheque-ref').value = doc.chequeRef;
            document.getElementById('cheque-bank').value = doc.chequeBank;
            document.getElementById('account-title').value = doc.accountTitle;
            document.getElementById('amount-received').value = (doc.amountReceived || 0).toLocaleString('en-US');
            
            // Recalculate and set computed fields
            updateAmountInWords();
            calculateAccountReceivable();
        }

        function formatAndCalculate(event) {
            const input = event.target;
            // 1. Remove all non-digit characters (except the decimal point if needed)
            let value = input.value.replace(/[^0-9.]/g, ''); 

            if (value !== "") {
                // 2. Convert to number, then back to a comma-formatted string
                value = parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 0});
            }
            // 3. Update input value (this is the automatic comma formatting)
            input.value = value;
            
            // 4. Update dependent fields
            updateAmountInWords();
            calculateAccountReceivable();
        }

        function updateAmountInWords() {
            const amountReceivedInput = document.getElementById('amount-received');
            const amountInWordsInput = document.getElementById('amount-in-words');
            // Remove commas before parsing
            let amountValue = parseFloat(amountReceivedInput.value.replace(/,/g, '')) || 0;
            
            const words = numberToWords(amountValue);
            amountInWordsInput.value = words ? words + " only" : "";
        }

        // Robust function to convert numbers to words (up to crores)
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            // Pad to 9 digits and match: (crore) (lakh) (thousand) (hundred) (ten/unit)
            let n = ('000000000' + Math.floor(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '' && n[4] == 0) ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim().charAt(0).toUpperCase() + str.trim().slice(1);
        }

        function calculateAccountReceivable() {
            // Remove commas before calculation
            const previousBalance = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
            const amountReceived = parseFloat(document.getElementById('amount-received').value.replace(/,/g, '')) || 0;
            
            // Account Receivable is Previous Balance MINUS Amount Received
            const accountReceivable = previousBalance - amountReceived;
            
            // Display the result with comma formatting and the suffix
            document.getElementById('account-receivable').textContent = `PKR: ${accountReceivable.toLocaleString('en-US')}/=`;
        }
    
        function savePayment() {
            const receiptNumber = document.getElementById('receipt-no').value;
            const receiptDate = document.getElementById('receipt-date').value;
            const receivedFrom = document.getElementById('received-from').value;
            const businessLedger = document.getElementById('business-ledger').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            // Parse numerical values after removing commas
            const previousBalance = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
            const amountReceived = parseFloat(document.getElementById('amount-received').value.replace(/,/g, '')) || 0;

            const chequeRef = document.getElementById('cheque-ref').value;
            const chequeBank = document.getElementById('cheque-bank').value;
            const accountTitle = document.getElementById('account-title').value;
            const amountInWords = document.getElementById('amount-in-words').value;
            const accountReceivable = parseFloat(document.getElementById('account-receivable').textContent.replace(/PKR: |\/=|,/g, '')) || 0;

            const newReceipt = {
                number: receiptNumber,
                date: receiptDate,
                receivedFrom: receivedFrom,
                businessLedger: businessLedger,
                paymentMethod: paymentMethod,
                previousBalance: previousBalance,
                chequeRef: chequeRef,
                chequeBank: chequeBank,
                accountTitle: accountTitle,
                amountReceived: amountReceived,
                amountInWords: amountInWords,
                accountReceivable: accountReceivable,
                type: 'Customer Payment'
            };

            if (isEditing) {
                const docIndex = documents.findIndex(doc => doc.number === originalDocNumber);
                if (docIndex > -1) {
                    documents[docIndex] = newReceipt;
                    updateLedgerEntry(originalDocNumber, newReceipt);
                    alert('Receipt updated successfully!');
                }
            } else {
                documents.push(newReceipt);
                const newLedgerEntry = {
                    date: receiptDate,
                    description: `Payment from ${businessLedger} #${receiptNumber}`,
                    debit: amountReceived, // Increase Cash/Bank (Debit)
                    credit: 0,
                    accountType: 'Accounts Receivable', // Reduce A/R (Credit) is usually the credit side, but for simplicity in a single-entry view: debit=increase cash, credit=increase liability. Here we focus on the Cash/Bank flow.
                    doc_number: receiptNumber
                };
                ledger.push(newLedgerEntry);
                alert('Payment saved and ledger updated!');
            }
            saveData();
        }
        
        function updateLedgerEntry(oldDocNumber, newReceipt) {
            const ledgerIndex = ledger.findIndex(entry => entry.doc_number === oldDocNumber);
            if (ledgerIndex > -1) {
                ledger[ledgerIndex].date = newReceipt.date;
                ledger[ledgerIndex].description = `Payment from ${newReceipt.businessLedger} #${newReceipt.number}`;
                ledger[ledgerIndex].debit = newReceipt.amountReceived;
            }
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const content = document.body;
            const receiptNumber = document.getElementById('receipt-no').value;

            doc.html(content, {
                callback: function (doc) {
                    doc.save(`Receipt-#${receiptNumber}.pdf`);
                },
                x: 10,
                y: 10,
                html2canvas: { scale: 0.5 }
            });
        }
    </script>
</body>
</html>
