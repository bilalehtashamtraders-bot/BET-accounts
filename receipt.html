<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Payment Receipt - BET</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; color: #000; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .company-info { text-align: right; }
        .company-info h2 { margin: 0; color: #003366; }
        .receipt-heading { font-size: 28px; font-weight: bold; color: #2e6da4; line-height: 1.5; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 2px solid #000; }
        th, td { padding: 10px; text-align: center; }
        .label { text-align: left !important; font-weight: bold; }
        .action-buttons button { padding: 10px; margin: 10px 5px 10px 0; cursor: pointer; background-color: #2e6da4; color: white; border: none; border-radius: 4px; }
        .action-buttons button:hover { background-color: #245a8e; }
        .delete-button { background-color: #cc0000 !important; }
        .delete-button:hover { background-color: #aa0000 !important; }
        input { border: none; width: 100%; text-align: center; background: transparent; }
        input:focus { outline: none; background: #e6f0fa; }
        .amount-input { text-align: right !important; }
        .payment-method { margin-bottom: 15px; }
        .payment-method label { font-weight: bold; margin-right: 10px; }
        .payment-method select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: auto; min-width: 300px; }
        
        /* Signature Section Styles - Adopted from Sales Invoice */
        .signature { display: flex; justify-content: flex-end; margin-top: 50px; padding: 0 10px; align-items: flex-end; }
        .signature-right { text-align: center; width: 200px; }
        .signature-heading { 
            font-weight: bold; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #ccc; 
            display: inline-block;
            width: 100%;
        }
        
        /* SVG Signature Path Animation - Adopted from Sales Invoice */
        .signature-path {
            fill: none;
            stroke: #000;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawSignature 2s ease-out forwards;
        }
        
        @keyframes drawSignature {
            to { stroke-dashoffset: 0; }
        }

        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 32px;
            color: rgba(200, 0, 0, 0.12);
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            user-select: none;
            letter-spacing: 2px;
        }
        .balance-status {
            font-size: 12px;
            margin-top: 5px;
            color: #2e6da4;
            font-style: italic;
        }
        @media print {
            .action-buttons { display: none; }
            .payment-method { display: none; }
            body { padding: 0; margin: 0; }
            .watermark {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 32px;
                color: rgba(200, 0, 0, 0.12);
                font-weight: 600;
                white-space: nowrap;
                z-index: 1000;
                letter-spacing: 2px;
            }
            .header {
                border-bottom: 2px solid #000;
                page-break-after: avoid;
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; }
            .company-info { text-align: center; margin-top: 10px; }
            .receipt-heading { font-size: 20px; }
            .payment-method select { width: 100%; min-width: auto; }
        }
    </style>
    </head>
<body>
    <div class="watermark">NOT VALID FOR COURT OR LEGAL PURPOSE</div>
    
    <div class="action-buttons" style="max-width: 800px; margin: 0 auto 20px;">
        <button onclick="saveReceipt()">Save/Update Receipt</button>
        <button onclick="deleteReceipt()" id="deleteButton" class="delete-button" style="display: none;">Delete Payment</button>
        <button onclick="generatePDF()">Generate PDF</button>
        <button onclick="window.print()">Print</button>
        <button onclick="window.location.href='documents.html'">View All Documents</button>
    </div>
    <div style="max-width: 800px; margin: 0 auto;" id="receipt-content">
        <div class="header">
            <div class="receipt-heading">
                CUSTOMER PAYMENT RECEIPT <br>
                Receipt No: <input type="text" id="receipt-no" placeholder="e.g., CR-0156" style="width: 150px;" readonly><br>
                Date: <input type="date" id="receipt-date" style="width: 150px;" onchange="handleDateOrAccountChange()"><br>
                Received from: <input type="text" id="received-from" placeholder="e.g., XYZ Textiles">
            </div>
            <div class="company-info">
                <h2>(BET) Bilal Ehtasham Traders</h2>
                <p><i>Deals in all kinds of Cotton and Polyester Yarn</i></p>
                <p>Cell: (+92)-324-2479096</p>
                <p>Email: bilalehtashamtraders@gmail.com</p>
            </div>
        </div>

        <div class="payment-method">
            <label for="paidToAccount">Received In Account:</label>
            <select id="paidToAccount">
                <option value="">-- Select Account --</option>
            </select>
        </div>

        <table>
            <tr>
                <td class="label" style="width: 50%;">Business (Ledger):</td>
                <td>
                    <input type="text" id="business-ledger" placeholder="e.g., Customer Name" list="customer-accounts-list" oninput="handleDateOrAccountChange()">
                    <datalist id="customer-accounts-list"></datalist>
                    <div id="balance-status" class="balance-status" style="display: none;"></div>
                </td>
            </tr>
            <tr>
                <td class="label">Previous Balance:</td>
                <td><input type="text" id="previous-balance" class="amount-input" readonly></td>
            </tr>
            <tr>
                <td class="label">Cheque/Online Ref:</td>
                <td><input type="text" id="cheque-ref" placeholder="e.g., 344151"></td>
            </tr>
            <tr>
                <td class="label">Cheque/Bank name:</td>
                <td><input type="text" id="cheque-bank" placeholder="e.g., HBL"></td>
            </tr>
            <tr>
                <td class="label">Account Title:</td>
                <td><input type="text" id="account-title" placeholder="e.g., Customer Account Title"></td>
            </tr>
        </table>

        <table class="amount-table">
            <tr>
                <th class="label" style="width: 50%;">Amount Received:</th>
                <td><input type="text" id="amount-received" class="amount-input" oninput="formatCurrencyInput(this)"></td>
            </tr>
            <tr>
                <th class="label">In Words:</th>
                <td><input type="text" id="amount-in-words" readonly></td>
            </tr>
        </table>

        <table class="totals">
            <tr>
                <td class="label" style="width: 80%;"><b>Remaining Receivable:</b></td>
                <td><input type="text" id="remaining-receivable" class="amount-input" style="font-weight:bold;" readonly></td>
            </tr>
        </table>

        <div class="signature">
            <div class="signature-right">
                <div class="signature-heading">Authorized Signature</div>
                <svg width="200" height="80" viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg">
                    <path class="signature-path" d="
                        M50,40 
                        C30,10 80,10 60,40 
                        C40,70 20,60 30,90 
                        C40,110 70,100 80,80
                        L90,30
                        L80,120
                        M80,70 L110,60
                        L120,20 L115,130
                        C115,130 120,90 130,80
                        C135,70 140,100 145,90
                        C150,80 155,100 160,90
                        C165,80 170,100 175,90
                        C180,80 185,100 190,90
                        C195,80 200,100 205,90
                        C210,80 215,100 220,90
                        C225,80 230,100 235,90
                        C240,80 245,100 250,90
                        L280,70
                    " />
                </svg>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCm_tjninuNgd11f0c4t6Qy9eDrq4KaCD4",
            authDomain: "bet-acc-software.firebaseapp.com",
            projectId: "bet-acc-software",
            storageBucket: "bet-acc-software.firebasestorage.app",
            messagingSenderId: "879522152449",
            appId: "1:879522152449:web:73b8ef899d5c1cbfd90000"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let isEditing = false;
        let originalDocNumber = null;
        const DEFAULT_STARTING_NUMBER = 155;

        // Fixed bank accounts that will always appear first
        const FIXED_ACCOUNTS = [
            "Meezan Bank",
            "United Bank Ltd",
            "Bank Al-Habib",
            "Cash in Hand",
            "Meezan Bank Ahmed Bilal",
            "Papa (Dasti)",
            "Askari Bank",
            "Drawings SadaPay (10% Account)",
            "Drawings",
            "Expenses"
        ];

        // --- Helper Functions for Date and Currency ---
        
        // Converts DD-MM-YYYY to YYYY-MM-DD for <input type="date">
        function formatDateToInput(dateStr) {
            if (!dateStr || dateStr.includes('-') === false) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                // Assuming DD-MM-YYYY storage format
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }

        // Converts YYYY-MM-DD from <input type="date"> to DD-MM-YYYY for display/storage
        function formatDateToDisplay(dateStr) {
            if (!dateStr || dateStr.includes('-') === false) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                // Assuming YYYY-MM-DD input format
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }

        /**
         * Converts a date string (DD-MM-YYYY or YYYY-MM-DD) to a comparable number (YYYYMMDD).
         * This ensures correct chronological ordering for filtering.
         * NOTE: This function is critical for 'fetchPreviousBalance' and should be robust.
         */
        function dateToComparableNumber(dateStr) {
            if (!dateStr) return 0;
            const parts = String(dateStr).split(/[-\/]/);
            if (parts.length === 3) {
                // Check if the format is DD-MM-YYYY (day is first)
                if (parts[0].length <= 2 && parts[2].length === 4) {
                    // Convert DD-MM-YYYY to YYYYMMDD
                    const year = parts[2];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[0].padStart(2, '0');
                    return parseInt(year + month + day);
                }
                // Check if the format is YYYY-MM-DD (year is first)
                if (parts[0].length === 4) {
                    // Convert YYYY-MM-DD to YYYYMMDD
                    const year = parts[0];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    return parseInt(year + month + day);
                }
            }
            return 0; // Invalid date
        }

        function formatCurrency(value) {
            const num = parseFloat(value) || 0;
            // Use comma separators and two fixed decimal places, as required by the existing logic
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '/=';
        }

        function parseCurrency(value) {
            return parseFloat(String(value).replace(/,/g, '').replace('/=', '')) || 0;
        }

        function formatCurrencyInput(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            if (value) {
                // Re-format the display value using US locale (comma thousands, period decimal)
                input.value = parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            } else {
                input.value = '';
            }
            calculateRemainingReceivable();
            updateAmountInWords();
        }
        // ---------------------------------------------


        async function getNextReceiptNumber() {
            try {
                const q = query(collection(db, "customerReceipts"), orderBy("numericNumber", "desc"), limit(1));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const lastDoc = snapshot.docs[0].data();
                    const lastNumber = parseInt(lastDoc.numericNumber, 10);
                    return 'CR-' + String(lastNumber + 1).padStart(4, '0');
                }
                return 'CR-' + String(DEFAULT_STARTING_NUMBER).padStart(4, '0');
            } catch (error) {
                console.error("Error getting next receipt number:", error);
                return 'CR-' + String(DEFAULT_STARTING_NUMBER).padStart(4, '0');
            }
        }

        async function fetchAllLedgerAccounts() {
            const selectElement = document.getElementById('paidToAccount');
            selectElement.innerHTML = '<option value="">-- Select Account --</option>';
            
            try {
                // First, add all fixed accounts
                FIXED_ACCOUNTS.forEach(accountName => {
                    const option = document.createElement('option');
                    option.value = accountName;
                    option.textContent = accountName;
                    selectElement.appendChild(option);
                });

                // Add a separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
                selectElement.appendChild(separator);

                // Then fetch and add ledger accounts
                const ledgerSnapshot = await getDocs(collection(db, "ledger"));
                const accounts = new Set();
                
                ledgerSnapshot.forEach(docSnap => {
                    const entry = docSnap.data();
                    if (entry.account && entry.account.trim() !== '') {
                        // Only add if not already in fixed accounts
                        if (!FIXED_ACCOUNTS.includes(entry.account)) {
                            accounts.add(entry.account);
                        }
                    }
                });

                // Sort ledger accounts alphabetically
                const sortedAccounts = Array.from(accounts).sort((a, b) => 
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                sortedAccounts.forEach(accountName => {
                    const option = document.createElement('option');
                    option.value = accountName;
                    option.textContent = accountName;
                    selectElement.appendChild(option);
                });
                
                console.log(`Dropdown populated with ${FIXED_ACCOUNTS.length} fixed accounts + ${accounts.size} ledger accounts.`);
            } catch (error) {
                console.error("Error fetching accounts for dropdown:", error);
            }
        }

        async function fetchCustomerAccounts() {
            const datalist = document.getElementById('customer-accounts-list');
            datalist.innerHTML = '';
            
            try {
                const ledgerSnapshot = await getDocs(collection(db, "ledger"));
                const accounts = new Set();
                
                ledgerSnapshot.forEach(docSnap => {
                    const entry = docSnap.data();
                    if (entry.account && entry.account.trim() !== '') {
                        accounts.add(entry.account);
                    }
                });

                accounts.forEach(accountName => {
                    const option = document.createElement('option');
                    option.value = accountName;
                    datalist.appendChild(option);
                });
                console.log(`Datalist populated with ${accounts.size} unique ledger accounts.`);
            } catch (error) {
                console.error("Error fetching accounts for datalist:", error);
            }
        }

        /**
         * Calculates the previous balance for a customer up to the specified transaction date.
         * @param {string} customerName - The customer's account name.
         * @param {string} dateInput - The YYYY-MM-DD date from the receipt date input field.
         */
        async function fetchPreviousBalance(customerName, dateInput) {
            const previousBalanceInput = document.getElementById('previous-balance');
            const statusDiv = document.getElementById('balance-status');

            if (!customerName || customerName.trim() === '' || !dateInput) {
                previousBalanceInput.value = formatCurrency(0);
                statusDiv.style.display = 'none';
                calculateRemainingReceivable();
                return;
            }

            // Convert input date (YYYY-MM-DD) to a comparable number (YYYYMMDD) for filtering
            const cutoffDateNumber = dateToComparableNumber(dateInput);
            const searchLower = customerName.toLowerCase().trim();

            statusDiv.style.display = 'block';
            statusDiv.textContent = `Fetching balance till ${formatDateToDisplay(dateInput)}...`;

            try {
                const ledgerQuery = query(collection(db, "ledger"));
                const ledgerSnapshot = await getDocs(ledgerQuery);

                let customerBalance = 0;
                let foundEntries = 0;

                ledgerSnapshot.forEach((doc) => {
                    const entry = doc.data();
                    const entryDateNumber = dateToComparableNumber(entry.date);
                    
                    // Only include transactions for the customer that occurred ON or BEFORE the receipt date.
                    if (entry.account && entry.account.toLowerCase().trim() === searchLower && entryDateNumber <= cutoffDateNumber) {
                        customerBalance += parseFloat(entry.debit || 0);
                        customerBalance -= parseFloat(entry.credit || 0);
                        foundEntries++;
                    }
                });

                previousBalanceInput.value = formatCurrency(customerBalance);

                if (foundEntries > 0) {
                    statusDiv.textContent = `âœ“ Balance till ${formatDateToDisplay(dateInput)}: ${formatCurrency(customerBalance)}`;
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
                } else {
                    statusDiv.textContent = `âœ— No transactions found for this customer till ${formatDateToDisplay(dateInput)}`;
                    previousBalanceInput.value = formatCurrency(0);
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
                }

                calculateRemainingReceivable();

            } catch (error) {
                console.error("Error fetching previous balance:", error);
                statusDiv.textContent = 'âœ— Error fetching balance';
                setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            }
        }
        
        // New handler to call fetchPreviousBalance when either date or account changes
        function handleDateOrAccountChange() {
            const customerName = document.getElementById('business-ledger').value;
            const receiptDate = document.getElementById('receipt-date').value; // YYYY-MM-DD format
            fetchPreviousBalance(customerName, receiptDate);
        }
        window.handleDateOrAccountChange = handleDateOrAccountChange; // Expose to global scope for HTML event attributes

        function attachListeners() {
            // Updated to use the new centralized handler
            document.getElementById('amount-received').addEventListener('input', function(e) {
                formatCurrencyInput(e.target);
            });
        }

        function calculateRemainingReceivable() {
            const previousBalance = parseCurrency(document.getElementById('previous-balance').value);
            const amountReceived = parseCurrency(document.getElementById('amount-received').value);
            const remaining = previousBalance - amountReceived;
            document.getElementById('remaining-receivable').value = formatCurrency(remaining);
        }

        function updateAmountInWords() {
            const amountReceivedInput = document.getElementById('amount-received');
            const amountInWordsInput = document.getElementById('amount-in-words');
            let amountValue = parseCurrency(amountReceivedInput.value) || 0;
            
            const words = numberToWords(amountValue);
            amountInWordsInput.value = words ? words + " only" : "";
        }

        function numberToWords(num) {
            if (num === 0) return 'Zero';
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            let n = ('000000000' + Math.floor(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '' && n[4] == 0) ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim().charAt(0).toUpperCase() + str.trim().slice(1);
        }

        function populateForm(doc) {
            document.getElementById('receipt-no').value = doc.number;
            // Update date format for HTML date input
            const dateInput = formatDateToInput(doc.date);
            document.getElementById('receipt-date').value = dateInput;
            
            document.getElementById('received-from').value = doc.receivedFrom;
            document.getElementById('business-ledger').value = doc.businessLedger;
            document.getElementById('paidToAccount').value = doc.paidToAccountID || '';
            document.getElementById('cheque-ref').value = doc.chequeRef || '';
            document.getElementById('cheque-bank').value = doc.chequeBank || '';
            document.getElementById('account-title').value = doc.accountTitle || '';
            document.getElementById('amount-received').value = formatCurrency(doc.amountReceived || 0);
            
            // Re-calculate previous balance based on the document's own date
            document.getElementById('previous-balance').value = formatCurrency(doc.previousBalance || 0);
            calculateRemainingReceivable();
            // ðŸ’¡ CRITICAL: Recalculate based on the fetched date and account name
            fetchPreviousBalance(doc.businessLedger, dateInput); 
        }

        window.saveReceipt = async function() {
            const receiptNumber = document.getElementById('receipt-no').value;
            // Get date from HTML input and convert to DD-MM-YYYY for storage
            const receiptDateInput = document.getElementById('receipt-date').value;
            const receiptDate = formatDateToDisplay(receiptDateInput);

            const receivedFrom = document.getElementById('received-from').value;
            const businessLedger = document.getElementById('business-ledger').value;
            const paidToAccount = document.getElementById('paidToAccount').value;
            // Store the dynamically calculated previous balance
            const previousBalance = parseCurrency(document.getElementById('previous-balance').value); 
            const amountReceived = parseCurrency(document.getElementById('amount-received').value);
            const chequeRef = document.getElementById('cheque-ref').value;
            const chequeBank = document.getElementById('cheque-bank').value;
            const accountTitle = document.getElementById('account-title').value;
            const amountInWords = document.getElementById('amount-in-words').value;
            const remainingReceivable = parseCurrency(document.getElementById('remaining-receivable').value);

            if (!receiptDate || !receivedFrom || !businessLedger) {
                alert("Please fill in Date, Received From, and Business (Ledger) fields.");
                return;
            }
            if (!paidToAccount) {
                alert("Please select the Account the payment was received to.");
                return;
            }
            if (amountReceived <= 0) {
                alert("Please enter a valid amount received.");
                return;
            }

            const numericNumber = parseInt(receiptNumber.replace('CR-', ''), 10);
            const newReceipt = {
                number: receiptNumber,
                numericNumber: numericNumber,
                date: receiptDate,
                receivedFrom: receivedFrom,
                businessLedger: businessLedger,
                paidToAccountID: paidToAccount,
                previousBalance: previousBalance, // Save the date-specific balance
                chequeRef: chequeRef,
                chequeBank: chequeBank,
                accountTitle: accountTitle,
                amountReceived: amountReceived,
                amountInWords: amountInWords,
                remainingReceivable: remainingReceivable,
                type: 'Customer Payment',
                timestamp: new Date().toISOString()
            };

            try {
                // 1. Save/Update Receipt Document
                await setDoc(doc(db, "customerReceipts", receiptNumber), newReceipt);
                console.log("âœ“ Receipt saved to customerReceipts collection");

                // --- Handle Deletion of Old Document/Ledger Entries on Edit ---
                if (isEditing && originalDocNumber && originalDocNumber !== receiptNumber) {
                    await deleteDoc(doc(db, "customerReceipts", originalDocNumber));
                    const oldLedgerQuery = query(collection(db, "ledger"), where("doc_number", "==", originalDocNumber));
                    const oldLedgerSnapshot = await getDocs(oldLedgerQuery);
                    for (const docSnap of oldLedgerSnapshot.docs) {
                        await deleteDoc(doc(db, "ledger", docSnap.id));
                    }
                    console.log("âœ“ Old receipt and related ledger entries deleted");
                }

                // 2. Clear Existing Ledger Entries for THIS Receipt
                const existingLedgerQuery = query(collection(db, "ledger"), where("doc_number", "==", receiptNumber));
                const existingLedgerSnapshot = await getDocs(existingLedgerQuery);
                for (const docSnap of existingLedgerSnapshot.docs) {
                    await deleteDoc(doc(db, "ledger", docSnap.id));
                }
                console.log("âœ“ Existing ledger entries cleared for re-entry");

                // 3. Create NEW Ledger Entries (Double Entry)
                
                // Entry 1: Debit (Money received into Cash/Bank Account)
                // DESCRIPTION FIXED: Does not show customer name (businessLedger) in fixed account ledger
                const ledgerEntryDebit = {
                    date: receiptDate,
                    account: paidToAccount, // e.g., Meezan Bank (Fixed Account)
                    description: `Payment Receipt against Doc No. ${receiptNumber}`,
                    debit: amountReceived,
                    credit: 0,
                    doc_number: receiptNumber,
                    doc_type: 'CR',
                    timestamp: new Date().toISOString()
                };

                // Entry 2: Credit (Customer's balance is reduced/credited)
                // DESCRIPTION FIXED: Shows context for the Customer's ledger
                const ledgerEntryCredit = {
                    date: receiptDate,
                    account: businessLedger, // e.g., XYZ Textiles (Customer Account)
                    description: `Payment Receipt to settle balance (Doc No. ${receiptNumber})`,
                    debit: 0,
                    credit: amountReceived, // **CRITICAL FIX: This must be credit to reduce receivable**
                    doc_number: receiptNumber,
                    doc_type: 'CR',
                    // Add a small delay for secondary entry to ensure sorting works correctly
                    timestamp: new Date(Date.now() + 10).toISOString() 
                };
                
                // Save both entries
                const ledgerDocRef1 = doc(collection(db, "ledger"));
                await setDoc(ledgerDocRef1, ledgerEntryDebit);
                
                const ledgerDocRef2 = doc(collection(db, "ledger"));
                await setDoc(ledgerDocRef2, ledgerEntryCredit);

                console.log("âœ“ All ledger entries saved successfully (Debit to Bank, Credit to Customer)");

                alert(isEditing ? 'Customer Receipt updated successfully!' : 'Customer Receipt saved and ledger updated!');
                window.location.href = 'documents.html';
            } catch (error) {
                console.error("âŒ Error saving receipt:", error);
                alert("Error saving receipt: " + error.message);
            }
        };

        window.deleteReceipt = async function() {
            const receiptNumber = document.getElementById('receipt-no').value;
            if (!confirm(`Are you sure you want to delete Customer Receipt ${receiptNumber}? This action cannot be undone.`)) {
                return;
            }

            try {
                const ledgerQuery = query(collection(db, "ledger"), where("doc_number", "==", receiptNumber));
                const ledgerSnapshot = await getDocs(ledgerQuery);
                for (const docSnap of ledgerSnapshot.docs) {
                    await deleteDoc(doc(db, "ledger", docSnap.id));
                }
                console.log(`âœ“ All ${ledgerSnapshot.size} ledger entries deleted`);

                await deleteDoc(doc(db, "customerReceipts", receiptNumber));
                console.log(`âœ“ Receipt document deleted`);

                alert(`Customer Receipt ${receiptNumber} and all related ledger entries deleted successfully.`);
                window.location.href = 'documents.html';
            } catch (error) {
                console.error("âŒ Error deleting receipt:", error);
                alert("Error deleting receipt: " + error.message);
            }
        };

        window.generatePDF = function() {
            // Hide the payment method dropdown before generating PDF
            const paymentMethodDiv = document.querySelector('.payment-method');
            const originalDisplay = paymentMethodDiv.style.display;
            paymentMethodDiv.style.display = 'none';

            const element = document.getElementById('receipt-content');
            const opt = {
                margin: 0.5,
                filename: `Customer-Receipt-${document.getElementById('receipt-no').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            const watermarkDiv = document.querySelector('.watermark');
            if (watermarkDiv) {
                watermarkDiv.style.position = 'absolute';
                watermarkDiv.style.zIndex = '1';
            }

            html2pdf().set(opt).from(element).save().then(() => {
                if (watermarkDiv) {
                    watermarkDiv.style.position = 'fixed';
                    watermarkDiv.style.zIndex = '1000';
                }
                // Restore the payment method dropdown display
                paymentMethodDiv.style.display = originalDisplay;
            });
        };

        document.addEventListener('DOMContentLoaded', async function() {
            await fetchAllLedgerAccounts();
            await fetchCustomerAccounts();

            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');

            if (editId) {
                const docRef = doc(db, "customerReceipts", editId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    populateForm(docSnap.data());
                    isEditing = true;
                    originalDocNumber = editId;
                    document.getElementById('deleteButton').style.display = 'inline-block';
                } else {
                    alert("Customer Receipt not found.");
                    window.location.href = 'documents.html';
                }
            } else {
                const nextReceiptNo = await getNextReceiptNumber();
                document.getElementById('receipt-no').value = nextReceiptNo;
                
                // Set default date to today, formatted for the HTML date input (YYYY-MM-DD)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const defaultDate = `${year}-${month}-${day}`;
                document.getElementById('receipt-date').value = defaultDate;
                
                document.getElementById('deleteButton').style.display = 'none';
                
                // Call initial balance fetch with default date
                fetchPreviousBalance(document.getElementById('business-ledger').value, defaultDate);
            }

            attachListeners();
            document.getElementById('remaining-receivable').setAttribute('readonly', true);
        });
    </script>
</body>
</html>
