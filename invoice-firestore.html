<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sales Invoice - BET</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; color: #000; }
    .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
    .company-info { text-align: right; }
    .company-info h2 { margin: 0; color: #003366; }
    .invoice-heading { font-size: 28px; font-weight: bold; color: #003366; line-height: 1.5; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 2px solid #000; }
    th, td { padding: 10px; text-align: center; }
    .totals { margin-top: 20px; width: 100%; }
    .totals td { padding: 8px; }
    .totals .label { text-align: right; font-weight: bold; }
    .action-buttons button { padding: 10px; margin: 10px 5px 10px 0; cursor: pointer; background-color: #003366; color: white; border: none; }
    .delete-button { background-color: #cc0000 !important; }
    input { border: none; width: 100%; text-align: center; background: transparent; }
    input:focus { outline: none; background: #eef6ff; }
    .total-amount-input { text-align: right !important; }
    .payment-method { margin-bottom: 15px; }
    .signature { display: flex; justify-content: space-between; margin-top: 50px; padding: 0 10px; }
    .signature-right { padding-top: 5px; font-weight: bold; text-transform: uppercase; }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxxxxxxx",
      authDomain: "your-app.firebaseapp.com",
      projectId: "your-app",
      storageBucket: "your-app.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdefg12345"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; // make it global

    // --- INVOICE LOGIC ---
    const LBS_IN_KG = 2.20462;
    const PREFIX = "SI-";
    const DEFAULT_STARTING_NUMBER = 156;
    let isEditing = false;
    let originalDocumentID = null;

    function getNextInvoiceNumber() {
      let lastNumber = localStorage.getItem("lastInvoiceNumber") || DEFAULT_STARTING_NUMBER;
      const nextNumber = parseInt(lastNumber) + 1;
      return String(nextNumber).padStart(5, "0");
    }

    function setLastInvoiceNumber(num) {
      localStorage.setItem("lastInvoiceNumber", num);
    }

    function calculateRowAndTotals(row) {
      const q = parseFloat(row.querySelector(".quantity").value) || 0;
      const p = parseFloat(row.querySelector(".packing").value) || 0;
      const price = parseFloat(row.querySelector(".price").value) || 0;
      const weightKg = q * p;
      const weightLbs = weightKg * LBS_IN_KG;
      const amount = weightLbs * price;
      row.querySelector(".weightKg").value = weightKg.toFixed(2);
      row.querySelector(".weightLbs").value = weightLbs.toFixed(2);
      row.querySelector(".amount").value = amount.toFixed(2);
      calculateTotals();
    }

    function calculateTotals() {
      let gross = 0;
      document.querySelectorAll(".amount").forEach(a => gross += parseFloat(a.value) || 0);
      const cartage = parseFloat(document.getElementById("cartage").value) || 0;
      document.getElementById("grossTotal").value = gross.toFixed(2);
      document.getElementById("netTotal").value = (gross + cartage).toFixed(2);
    }

    function addRow() {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" class="quantity" value="0"></td>
        <td><input type="text" class="description"></td>
        <td><input type="text" class="packing" value="0"></td>
        <td><input type="text" class="weightKg" value="0.00" readonly></td>
        <td><input type="text" class="weightLbs" value="0.00" readonly></td>
        <td><input type="text" class="price" value="0"></td>
        <td><input type="text" class="amount total-amount-input" value="0.00" readonly></td>`;
      document.getElementById("invoice-body").appendChild(row);
      attachListeners(row);
    }

    function attachListeners(row) {
      ["quantity","packing","price"].forEach(cls => {
        row.querySelector("." + cls).addEventListener("input", e => calculateRowAndTotals(row));
      });
    }

    function getLineItems() {
      const items = [];
      document.querySelectorAll("#invoice-body tr").forEach(r => {
        items.push({
          quantity: parseFloat(r.querySelector(".quantity").value) || 0,
          description: r.querySelector(".description").value,
          packing: parseFloat(r.querySelector(".packing").value) || 0,
          weightKg: parseFloat(r.querySelector(".weightKg").value) || 0,
          weightLbs: parseFloat(r.querySelector(".weightLbs").value) || 0,
          price: parseFloat(r.querySelector(".price").value) || 0,
          amount: parseFloat(r.querySelector(".amount").value) || 0,
        });
      });
      return items;
    }

    async function saveInvoice() {
      const number = document.getElementById("invoiceNumber").value;
      const date = document.getElementById("invoiceDate").value;
      const party = document.getElementById("partyName").value;
      const cartage = parseFloat(document.getElementById("cartage").value) || 0;
      const gross = parseFloat(document.getElementById("grossTotal").value) || 0;
      const net = parseFloat(document.getElementById("netTotal").value) || 0;
      const paymentMethod = document.getElementById("paymentMethod").value;
      const paymentTerms = document.getElementById("paymentTerms").value;

      if (!number || !date || !party || net <= 0) {
        alert("Fill invoice number, date, party name and ensure net total > 0.");
        return;
      }

      const docID = PREFIX + number;
      const invoiceDoc = {
        documentID: docID,
        number, date, party,
        paymentMethod, paymentTerms,
        lineItems: getLineItems(),
        cartage, grossTotal: gross, netTotal: net
      };

      try {
        await setDoc(doc(db, "Invoices", docID), invoiceDoc);
        alert("Invoice saved to Firebase!");
        setLastInvoiceNumber(parseInt(number));
      } catch (e) {
        console.error(e);
        alert("Error saving invoice.");
      }
    }

    async function deleteInvoice() {
      const number = document.getElementById("invoiceNumber").value;
      if (!number) return;
      const docID = PREFIX + number;
      if (confirm("Delete Invoice " + number + "?")) {
        try {
          await deleteDoc(doc(db, "Invoices", docID));
          alert("Deleted from Firebase!");
        } catch (e) {
          console.error(e);
          alert("Error deleting invoice.");
        }
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("invoiceNumber").value = getNextInvoiceNumber();
      document.getElementById("invoiceDate").value = new Date().toLocaleDateString("en-GB");
      document.querySelectorAll("#invoice-body tr").forEach(r => attachListeners(r));
      document.getElementById("cartage").addEventListener("input", calculateTotals);
    });

    window.saveInvoice = saveInvoice;
    window.deleteInvoice = deleteInvoice;
    window.addRow = addRow;
  </script>
</head>
<body>
  <div class="action-buttons" style="max-width: 800px; margin: 0 auto 20px;">
    <button onclick="saveInvoice()">Save Invoice</button>
    <button onclick="deleteInvoice()" class="delete-button">Delete Invoice</button>
    <button onclick="addRow()">Add New Row</button>
  </div>
  <div style="max-width: 800px; margin: 0 auto;">
    <div class="header">
      <div class="invoice-heading">
        SALES INVOICE <br>
        Invoice Number: <input type="text" id="invoiceNumber" readonly><br>
        Date: <input type="text" id="invoiceDate"><br>
        Party Name: <input type="text" id="partyName">
      </div>
      <div class="company-info">
        <h2>(BET) Bilal Ehtasham Traders</h2>
        <p><i>We deal in all kinds of Cotton and Polyester Yarn</i></p>
        <p>Cell: (+92)-324-2479096</p>
        <p>Email: bilalehtashamtraders@gmail.com</p>
      </div>
    </div>

    <div class="payment-method">
      <label>Payment Method:</label>
      <select id="paymentMethod">
        <option value="Bank Transfer">Bank Transfer</option>
        <option value="Cash">Cash</option>
        <option value="Cheque">Cheque</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Quantity</th>
          <th>Description</th>
          <th>Packing (kg)</th>
          <th>Weight (kg)</th>
          <th>Weight (lbs)</th>
          <th>Price</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="invoice-body">
        <tr>
          <td><input type="text" class="quantity" value="0"></td>
          <td><input type="text" class="description"></td>
          <td><input type="text" class="packing" value="0"></td>
          <td><input type="text" class="weightKg" value="0.00" readonly></td>
          <td><input type="text" class="weightLbs" value="0.00" readonly></td>
          <td><input type="text" class="price" value="0"></td>
          <td><input type="text" class="amount total-amount-input" value="0.00" readonly></td>
        </tr>
      </tbody>
    </table>

    <table class="totals">
      <tr>
        <td class="label" style="width: 80%;">Gross Total:</td>
        <td><input type="text" id="grossTotal" class="total-amount-input" readonly></td>
      </tr>
      <tr>
        <td class="label">Cartage:</td>
        <td><input type="text" id="cartage" class="total-amount-input" value="0"></td>
      </tr>
      <tr>
        <td class="label"><b>Net Total:</b></td>
        <td><input type="text" id="netTotal" class="total-amount-input" readonly></td>
      </tr>
    </table>

    <div class="signature">
      <div class="signature-left">
        Payment Terms: <input type="text" id="paymentTerms">
      </div>
      <div class="signature-right">(EHTASHAM BILAL)</div>
    </div>
  </div>
</body>
</html>
