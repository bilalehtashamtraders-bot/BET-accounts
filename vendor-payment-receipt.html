<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Payment Voucher - Bilal Ehtasham Traders</title>
    <style>
        /* CSS STYLES FOR THE RECEIPT FORM */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .receipt-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .details-table td {
            padding: 8px 0;
            font-size: 14px;
        }
        .details-table .label {
            font-weight: bold;
            width: 150px;
        }
        .editable-field {
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
            width: calc(100% - 160px);
            padding: 2px 0;
            background: transparent;
        }
        #amount-in-words-container {
            width: calc(100% - 100px);
        }
        #amount-in-words {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
            background: transparent;
        }
        .amount-section {
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .amount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .amount-row .label {
            font-weight: bold;
        }
        .calculated-value {
            font-weight: bold;
        }
        .action-buttons button {
            padding: 10px;
            margin: 10px 5px 10px 0; 
            cursor: pointer;
            background-color: #003366;
            color: white;
            border: none;
        }
        .payment-method {
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .input-group input {
            flex-grow: 1; 
            text-align: right;
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            padding: 2px 0;
        }
        .input-group .suffix {
            margin-left: 5px;
            font-weight: bold;
            white-space: nowrap;
        }
        .input-group span:first-child {
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="action-buttons" style="max-width: 600px; margin: 0 auto; margin-bottom: 20px;">
        <button onclick="savePayment()">Save/Update Payment</button>
        <button onclick="deletePayment()" id="deleteButton" style="background-color: #cc0000; display: none;">Delete Payment</button>
        <button onclick="generatePDF()">Generate PDF</button>
    </div>

    <div class="receipt-container">
        <div class="header">
            <h1>VENDOR PAYMENT VOUCHER</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>
    
        <table class="details-table">
            <tr>
                <td class="label">Voucher No:</td>
                <td><input type="text" class="editable-field" id="receipt-no" placeholder="e.g., 00100" readonly></td>
            </tr>
            <tr>
                <td class="label">Date:</td>
                <td><input type="text" class="editable-field" id="receipt-date" placeholder="e.g., 27-09-2025"></td>
            </tr>
            <tr>
                <td class="label">Paid To:</td> <td><input type="text" class="editable-field" id="received-from" placeholder="e.g., XYZ Suppliers"></td>
            </tr>
            <tr>
                <td class="label">Business (Ledger):</td>
                <td><input type="text" class="editable-field" id="business-ledger" placeholder="e.g., Vendor Name"></td>
            </tr>
        </table>
    
        <div class="payment-method">
            <label for="paymentMethod">Payment Method:</label>
            <select id="paymentMethod">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
            </select>
        </div>
    
        <table class="details-table">
            <tr>
                <td class="label">Previous Payable:</td>
                <td>
                    <div class="input-group">
                        <span>PKR:</span>
                        <input type="text" id="previous-balance" style="width: 100%;">
                        <span class="suffix">/=</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label">Cheque/Online Ref:</td>
                <td><input type="text" class="editable-field" id="cheque-ref" placeholder="e.g., 344151"></td>
            </tr>
            <tr>
                <td class="label">Cheque/Bank name:</td>
                <td><input type="text" class="editable-field" id="cheque-bank" placeholder="e.g., HBL"></td>
            </tr>
            <tr>
                <td class="label">Account Title:</td>
                <td><input type="text" class="editable-field" id="account-title" placeholder="e.g., Vendor Account Title"></td>
            </tr>
        </table>
    
        <div class="amount-section">
            <div class="amount-row">
                <span class="label">Amount Paid:</span> <div class="input-group">
                    <span>PKR:</span>
                    <input type="text" id="amount-received" style="width: 100%;">
                    <span class="suffix">/=</span>
                </div>
            </div>
            <div class="amount-row">
                <span class="label">In Words:</span>
                <span id="amount-in-words-container">
                    <input type="text" id="amount-in-words" placeholder="e.g., Fifty seven thousand only" readonly>
                </span>
            </div>
        </div>
    
        <div class="amount-section">
            <div class="amount-row">
                <span class="label">Accounts Payable:</span> <span class="calculated-value" id="account-receivable">PKR: 0/=</span>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        // --- START: Placeholder/Mock data.js content for functionality ---
        let documents = []; // Mock array for payments
        let ledger = [];    // Mock array for ledger
        
        function saveData() {
            console.log("Data saved (documents and ledger)");
        }

        function loadData() {
            console.log("Data loaded (documents and ledger)");
        }
        // --- END: Placeholder/Mock data.js content for functionality ---


        let isEditing = false;
        let originalDocNumber = null;
        
        // =====================================================================
        // CRITICAL FIX: Use a UNIQUE key for VENDOR PAYMENT to avoid conflict
        // =====================================================================
        const VENDOR_PAYMENT_KEY = 'lastVendorPaymentNumber_BET'; // Unique key!
        const STARTING_PAYMENT_NUMBER = 99; // Next will be 100 (for 0100)

        // Function to get the next voucher number
        function getNextReceiptNumber() { // Kept function name same as receipt.html for consistency
            // Use the explicit key
            let lastNumber = parseInt(localStorage.getItem(VENDOR_PAYMENT_KEY), 10); 
            
            // If it's the first time, set the initial value (99, so next is 100)
            if (isNaN(lastNumber) || lastNumber < STARTING_PAYMENT_NUMBER) {
                lastNumber = STARTING_PAYMENT_NUMBER;
            }

            const nextNumber = lastNumber + 1;
            
            // Format with leading zeros (e.g., 100 -> '0100')
            return String(nextNumber).padStart(4, '0');
        }

        // Function to set the last used voucher number
        function setLastReceiptNumber(number) { // Kept function name same as receipt.html for consistency
            // Use the explicit key
            localStorage.setItem(VENDOR_PAYMENT_KEY, number); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Load any mock data
            
            const docToEdit = JSON.parse(localStorage.getItem('docToEdit'));
            
            if (docToEdit) {
                populateForm(docToEdit);
                isEditing = true;
                originalDocNumber = docToEdit.number;
                localStorage.removeItem('docToEdit');
                document.getElementById('deleteButton').style.display = 'inline-block';
            } else {
                // Generate the next sequential voucher number
                const nextReceiptNo = getNextReceiptNumber();
                document.getElementById('receipt-no').value = nextReceiptNo;
                document.getElementById('receipt-date').value = new Date().toLocaleDateString('en-GB');
                document.getElementById('deleteButton').style.display = 'none';
            }
            
            document.getElementById('previous-balance').addEventListener('input', formatAndCalculate);
            document.getElementById('amount-received').addEventListener('input', formatAndCalculate);
            calculateAccountReceivable();
        });

        function populateForm(doc) {
            document.getElementById('receipt-no').value = doc.number;
            document.getElementById('receipt-date').value = doc.date;
            document.getElementById('received-from').value = doc.receivedFrom; // Used as Paid To
            document.getElementById('business-ledger').value = doc.businessLedger; // Used as Vendor Ledger
            document.getElementById('paymentMethod').value = doc.paymentMethod;
            
            document.getElementById('previous-balance').value = (doc.previousBalance || 0).toLocaleString('en-US', {maximumFractionDigits: 0}); // Used as Previous Payable
            document.getElementById('cheque-ref').value = doc.chequeRef;
            document.getElementById('cheque-bank').value = doc.chequeBank;
            document.getElementById('account-title').value = doc.accountTitle;
            document.getElementById('amount-received').value = (doc.amountReceived || 0).toLocaleString('en-US', {maximumFractionDigits: 0}); // Used as Amount Paid
            
            updateAmountInWords();
            calculateAccountReceivable();
        }

        function formatAndCalculate(event) {
            const input = event.target;
            let value = input.value.replace(/[^0-9.]/g, ''); 

            if (value !== "") {
                value = parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 0});
            }
            input.value = value;
            
            updateAmountInWords();
            calculateAccountReceivable();
        }

        function updateAmountInWords() {
            const amountReceivedInput = document.getElementById('amount-received');
            const amountInWordsInput = document.getElementById('amount-in-words');
            let amountValue = parseFloat(amountReceivedInput.value.replace(/,/g, '')) || 0;
            
            const words = numberToWords(amountValue);
            amountInWordsInput.value = words ? words + " only" : "";
        }

        function numberToWords(num) {
            if (num === 0) return 'Zero';
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            let n = ('000000000' + Math.floor(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return '';
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '' && n[4] == 0) ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim().charAt(0).toUpperCase() + str.trim().slice(1);
        }

        function calculateAccountReceivable() { // Used for Accounts Payable calculation
            const previousBalance = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
            const amountReceived = parseFloat(document.getElementById('amount-received').value.replace(/,/g, '')) || 0;
            
            // For Vendor Payment: Payable - Paid Amount = Remaining Payable
            const accountPayable = previousBalance - amountReceived;
            
            document.getElementById('account-receivable').textContent = `PKR: ${accountPayable.toLocaleString('en-US')}/=`;
        }

        function savePayment() {
            const voucherNumber = document.getElementById('receipt-no').value;
            const paymentDate = document.getElementById('receipt-date').value;
            const paidTo = document.getElementById('received-from').value;
            const businessLedger = document.getElementById('business-ledger').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const previousPayable = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
            const amountPaid = parseFloat(document.getElementById('amount-received').value.replace(/,/g, '')) || 0;

            const chequeRef = document.getElementById('cheque-ref').value;
            const chequeBank = document.getElementById('cheque-bank').value;
            const accountTitle = document.getElementById('account-title').value;
            const amountInWords = document.getElementById('amount-in-words').value;
            const accountPayable = parseFloat(document.getElementById('account-receivable').textContent.replace(/PKR: |\/=|,/g, '')) || 0;

            const newPayment = {
                number: voucherNumber,
                date: paymentDate,
                paidTo: paidTo,
                businessLedger: businessLedger,
                paymentMethod: paymentMethod,
                previousPayable: previousPayable,
                chequeRef: chequeRef,
                chequeBank: chequeBank,
                accountTitle: accountTitle,
                amountPaid: amountPaid,
                amountInWords: amountInWords,
                accountPayable: accountPayable,
                type: 'Vendor Payment'
            };

            if (isEditing) {
                const docIndex = documents.findIndex(doc => doc.number === originalDocNumber);
                if (docIndex > -1) {
                    documents[docIndex] = newPayment;
                    updateLedgerEntry(originalDocNumber, newPayment);
                    alert('Vendor Payment updated successfully!');
                }
            } else {
                documents.push(newPayment);
                const newLedgerEntry = {
                    date: paymentDate,
                    description: `Payment to ${businessLedger} #${voucherNumber}`,
                    debit: 0, // Payment is a credit to cash/bank and a debit to Accounts Payable (a liability account)
                    credit: amountPaid, 
                    accountType: 'Accounts Payable',
                    doc_number: voucherNumber
                };
                ledger.push(newLedgerEntry);
                
                // --- AUTOMATION STEP: Increment the payment number for the next new document ---
                const currentReceiptNumberInt = parseInt(voucherNumber, 10);
                setLastReceiptNumber(currentReceiptNumberInt);
                // ----------------------------------------------------------------------------

                alert('Vendor Payment saved and ledger updated!');
            }
            saveData();
        }
        
        function updateLedgerEntry(oldDocNumber, newPayment) {
            const ledgerIndex = ledger.findIndex(entry => entry.doc_number === oldDocNumber);
            if (ledgerIndex > -1) {
                ledger[ledgerIndex].date = newPayment.date;
                ledger[ledgerIndex].description = `Payment to ${newPayment.businessLedger} #${newPayment.number}`;
                ledger[ledgerIndex].credit = newPayment.amountPaid;
            }
        }

        function deletePayment() {
            if (confirm(`Are you sure you want to delete Vendor Payment voucher ${document.getElementById('receipt-no').value}? This cannot be undone.`)) {
                const docNumber = document.getElementById('receipt-no').value;

                // Delete from documents
                const docIndex = documents.findIndex(doc => doc.number === docNumber);
                if (docIndex > -1) {
                    documents.splice(docIndex, 1);
                }

                // Delete from ledger
                const ledgerIndex = ledger.findIndex(entry => entry.doc_number === docNumber);
                if (ledgerIndex > -1) {
                    ledger.splice(ledgerIndex, 1);
                }
                
                saveData(); 
                alert('Vendor Payment and associated ledger entry deleted successfully. Redirecting to new payment page.');
                window.location.reload(); // Reload to start a new voucher
            }
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const content = document.querySelector('.receipt-container'); 
            const receiptNumber = document.getElementById('receipt-no').value;

            doc.html(content, {
                callback: function (doc) {
                    doc.save(`VendorPayment-#${receiptNumber}.pdf`);
                },
                x: 10,
                y: 10,
                html2canvas: { scale: 0.5 }
            });
        }
    </script>
</body>
</html>
