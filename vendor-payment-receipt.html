<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
    // --- START: Placeholder/Mock data.js content for functionality ---
    // These are required by the savePayment and deletePayment functions in the provided HTML.
    let documents = []; // Mock array for all documents (receipts, payments)
    let ledger = [];    // Mock array for ledger entries
    
    function saveData() {
        // In a real application, this would save to a database or file.
        console.log("Data saved (documents and ledger)");
    }

    function loadData() {
        // In a real application, this would load data.
        console.log("Data loaded (documents and ledger)");
    }
    // --- END: Placeholder/Mock data.js content for functionality ---

    let isEditing = false;
    let originalDocNumber = null;
    
    // Use a unique key for Vendor Payments (VP) to separate from Customer Payments
    const VENDOR_PAYMENT_KEY = 'lastVendorPaymentNumber'; 
    const STARTING_VP_NUMBER = 150; // Next will be 151

    // Function to get the next vendor payment number
    function getNextPaymentNumber() {
        let lastNumber = parseInt(localStorage.getItem(VENDOR_PAYMENT_KEY), 10);
        
        // If it's the first time, or if the number is less than the desired start, set the initial value
        if (isNaN(lastNumber) || lastNumber < STARTING_VP_NUMBER) {
            lastNumber = STARTING_VP_NUMBER;
        }

        const nextNumber = lastNumber + 1;
        
        // Format with leading zeros (e.g., 151 -> '0151')
        return String(nextNumber).padStart(4, '0');
    }

    // Function to set the last used vendor payment number
    function setLastPaymentNumber(number) {
        localStorage.setItem(VENDOR_PAYMENT_KEY, number);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData(); 
        
        const docToEdit = JSON.parse(localStorage.getItem('docToEdit'));
        if (docToEdit) {
            populateForm(docToEdit);
            isEditing = true;
            originalDocNumber = docToEdit.number;
            localStorage.removeItem('docToEdit');
            document.getElementById('deleteButton').style.display = 'inline-block';
        } else {
            // Generate the next sequential payment number
            const nextPaymentNo = getNextPaymentNumber();
            document.getElementById('receipt-no').value = nextPaymentNo;
            
            document.getElementById('receipt-date').value = new Date().toLocaleDateString('en-GB');
            document.getElementById('deleteButton').style.display = 'none';
        }
        
        // Event listeners for comma formatting and calculation
        document.getElementById('previous-balance').addEventListener('input', formatAndCalculate);
        document.getElementById('amount-paid').addEventListener('input', formatAndCalculate);
        calculateAccountPayable();
    });

    function populateForm(doc) {
        document.getElementById('receipt-no').value = doc.number;
        document.getElementById('receipt-date').value = doc.date;
        document.getElementById('paid-to').value = doc.paidTo;
        document.getElementById('business-ledger').value = doc.businessLedger;
        document.getElementById('paymentMethod').value = doc.paymentMethod;
        
        document.getElementById('previous-balance').value = (doc.previousBalance || 0).toLocaleString('en-US', {maximumFractionDigits: 0});
        document.getElementById('cheque-ref').value = doc.chequeRef;
        document.getElementById('cheque-bank').value = doc.chequeBank;
        document.getElementById('account-title').value = doc.accountTitle;
        document.getElementById('amount-paid').value = (doc.amountPaid || 0).toLocaleString('en-US', {maximumFractionDigits: 0});

        updateAmountInWords();
        calculateAccountPayable();
    }

    function formatAndCalculate(event) {
        const input = event.target;
        let value = input.value.replace(/[^0-9.]/g, ''); 

        if (value !== "") {
            value = parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 0});
        }
        input.value = value;
        
        updateAmountInWords();
        calculateAccountPayable();
    }

    function updateAmountInWords() {
        const amountPaidInput = document.getElementById('amount-paid'); 
        const amountInWordsInput = document.getElementById('amount-in-words');
        let amountValue = parseFloat(amountPaidInput.value.replace(/,/g, '')) || 0;
        
        const words = numberToWords(amountValue);
        amountInWordsInput.value = words ? words + " only" : "";
    }

    function numberToWords(num) {
        if (num === 0) return 'Zero';
        const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
        const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        let n = ('000000000' + Math.floor(num)).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!n) return '';
        let str = '';
        str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
        str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
        str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
        str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
        str += (n[5] != 0) ? ((str != '' && n[4] == 0) ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
        return str.trim().charAt(0).toUpperCase() + str.trim().slice(1);
    }

    function calculateAccountPayable() {
        const previousBalance = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
        const amountPaid = parseFloat(document.getElementById('amount-paid').value.replace(/,/g, '')) || 0;
        
        const accountPayable = previousBalance - amountPaid;
        
        document.getElementById('account-payable').textContent = `PKR: ${accountPayable.toLocaleString('en-US')}/=`;
    }
    
    function savePayment() {
        const receiptNumber = document.getElementById('receipt-no').value;
        const receiptDate = document.getElementById('receipt-date').value;
        const paidTo = document.getElementById('paid-to').value;
        const businessLedger = document.getElementById('business-ledger').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        const previousBalance = parseFloat(document.getElementById('previous-balance').value.replace(/,/g, '')) || 0;
        const amountPaid = parseFloat(document.getElementById('amount-paid').value.replace(/,/g, '')) || 0;

        const chequeRef = document.getElementById('cheque-ref').value;
        const chequeBank = document.getElementById('cheque-bank').value;
        const accountTitle = document.getElementById('account-title').value;
        const amountInWords = document.getElementById('amount-in-words').value;
        const accountPayable = parseFloat(document.getElementById('account-payable').textContent.replace(/PKR: |\/=|,/g, '')) || 0;

        const newReceipt = {
            number: receiptNumber,
            date: receiptDate,
            paidTo: paidTo,
            businessLedger: businessLedger,
            paymentMethod: paymentMethod,
            previousBalance: previousBalance,
            chequeRef: chequeRef,
            chequeBank: chequeBank,
            accountTitle: accountTitle,
            amountPaid: amountPaid,
            amountInWords: amountInWords,
            accountPayable: accountPayable,
            type: 'Vendor Payment'
        };

        if (isEditing) {
            const docIndex = documents.findIndex(doc => doc.number === originalDocNumber);
            if (docIndex > -1) {
                documents[docIndex] = newReceipt;
                updateLedgerEntry(originalDocNumber, newReceipt);
                alert('Payment updated successfully!');
            }
        } else {
            documents.push(newReceipt);
            const newLedgerEntry = {
                date: receiptDate,
                description: `Payment to ${businessLedger} #${receiptNumber}`,
                debit: amountPaid, 
                credit: 0, 
                accountType: 'Accounts Payable',
                doc_number: receiptNumber
            };
            ledger.push(newLedgerEntry); 
            
            // --- AUTOMATION STEP: Increment the payment number for the next new document ---
            const currentPaymentNumberInt = parseInt(receiptNumber, 10);
            setLastPaymentNumber(currentPaymentNumberInt);
            // -----------------------------------------------------------------------------

            alert('Payment saved and ledger updated!');
        }
        saveData(); 
    }
    
    function updateLedgerEntry(oldDocNumber, newReceipt) {
        const ledgerIndex = ledger.findIndex(entry => entry.doc_number === oldDocNumber);
        if (ledgerIndex > -1) {
            ledger[ledgerIndex].date = newReceipt.date;
            ledger[ledgerIndex].description = `Payment to ${newReceipt.businessLedger} #${newReceipt.number}`;
            ledger[ledgerIndex].debit = newReceipt.amountPaid; 
        }
    }

    function deletePayment() {
        if (confirm(`Are you sure you want to delete payment number ${document.getElementById('receipt-no').value}? This cannot be undone.`)) {
            const docNumber = document.getElementById('receipt-no').value;

            const docIndex = documents.findIndex(doc => doc.number === docNumber);
            if (docIndex > -1) {
                documents.splice(docIndex, 1);
            }

            const ledgerIndex = ledger.findIndex(entry => entry.doc_number === docNumber);
            if (ledgerIndex > -1) {
                ledger.splice(ledgerIndex, 1);
            }
            
            saveData(); 
            alert('Payment and associated ledger entry deleted successfully. Redirecting to new payment page.');
            window.location.reload(); 
        }
    }
    
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const content = document.querySelector('.receipt-container'); 
        const receiptNumber = document.getElementById('receipt-no').value;

        doc.html(content, {
            callback: function (doc) {
                doc.save(`VendorPayment-#${receiptNumber}.pdf`);
            },
            x: 10,
            y: 10,
            html2canvas: { scale: 0.5 }
        });
    }
</script>
