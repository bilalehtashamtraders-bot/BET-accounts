<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Journal - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .report-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #002244;
        }
        .delete-button {
            background-color: #cc0000 !important;
        }
        .delete-button:hover {
            background-color: #aa0000 !important;
        }
        .form-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .form-row input, .form-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-je-no {
            flex: 0.5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .debit-column, .credit-column {
            text-align: right;
        }
        .total-row td {
            font-weight: bold;
            background-color: #e6e6ff;
        }
        .action-cell {
            text-align: center;
            width: 50px;
        }
        .action-cell button {
            padding: 4px 8px;
            background-color: #555;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #003366;
        }

        @media (max-width: 600px) {
            body {
                margin: 10px;
            }
            .report-container {
                padding: 10px;
            }
            .form-row {
                flex-direction: column;
                gap: 5px;
            }
            .form-row input, .form-row select {
                width: 100%;
            }
            .input-je-no {
                flex: 1;
            }
            table, th, td {
                font-size: 10px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading...</div>
    <div class="report-container" style="display: none;" id="mainContent">
        <div class="header">
            <h1>General Journal</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>
        
        <div class="controls">
            <button onclick="saveJournalEntry()">Save/Update Entry</button>
            <button onclick="deleteJournalEntry()" id="deleteButton" class="delete-button" style="display: none;">Delete Entry</button>
            <button onclick="generatePDF()">Generate PDF</button>
            <button onclick="window.location.href='documents.html'">View All Documents</button>
        </div>

        <div class="form-container">
            <h3>Journal Entry Details</h3>
            <div class="form-row">
                <input type="text" id="je-no" class="input-je-no" placeholder="JE No." readonly>
                <input type="text" id="entry-date" placeholder="Date (DD-MM-YYYY)">
                <input type="text" id="entry-narration" placeholder="Narration/Summary">
            </div>

            <h4>Line Items</h4>
            <div class="form-row">
                <select id="line-account-type">
                    <option value="Cash">Cash</option>
                    <option value="Revenue">Revenue</option>
                    <option value="Expense">Expense</option>
                    <option value="Accounts Receivable">Accounts Receivable</option>
                    <option value="Accounts Payable">Accounts Payable</option>
                    <option value="Bank">Bank</option>
                    <option value="Inventory">Inventory</option>
                    <option value="Fixed Assets">Fixed Assets</option>
                    <option value="Capital">Capital</option>
                    <option value="Drawings">Drawings</option>
                </select>
                <input type="text" id="line-description" placeholder="Description/Reference">
                <input type="text" id="line-debit" class="debit-input" placeholder="Debit (Rs.)">
                <input type="text" id="line-credit" class="credit-input" placeholder="Credit (Rs.)">
            </div>
            <button onclick="addLineItem()">Add Line</button>
        </div>
        
        <table id="journal-entries-table">
            <thead>
                <tr>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Debit (Rs.)</th>
                    <th>Credit (Rs.)</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody id="journal-lines-body">
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2">TOTAL</td>
                    <td id="total-debit" class="debit-column">0.00</td>
                    <td id="total-credit" class="credit-column">0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCm_tjninuNgd11f0c4t6Qy9eDrq4KaCD4",
            authDomain: "bet-acc-software.firebaseapp.com",
            projectId: "bet-acc-software",
            storageBucket: "bet-acc-software.firebasestorage.app",
            messagingSenderId: "879522152449",
            appId: "1:879522152449:web:73b8ef899d5c1cbfd90000"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let isEditing = false;
        let originalDocNumber = null;
        let lineItems = [];
        const DEFAULT_STARTING_NUMBER = 1000;

        async function getNextJENumber() {
            try {
                const q = query(collection(db, "journalEntries"), orderBy("number", "desc"), limit(1));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const lastDoc = snapshot.docs[0].data();
                    const lastNumber = parseInt(lastDoc.number.replace('JE-', ''));
                    const nextNumber = lastNumber + 1;
                    return `JE-${String(nextNumber).padStart(5, '0')}`;
                } else {
                    return `JE-${String(DEFAULT_STARTING_NUMBER + 1).padStart(5, '0')}`;
                }
            } catch (error) {
                console.error("Error getting next JE number:", error);
                return `JE-${String(DEFAULT_STARTING_NUMBER + 1).padStart(5, '0')}`;
            }
        }

        function formatInput(event) {
            const input = event.target;
            let value = input.value.replace(/[^0-9.]/g, '');
            
            if (value !== "") {
                value = parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            input.value = value;
        }

        async function populateForm(doc) {
            document.getElementById('je-no').value = doc.number;
            document.getElementById('entry-date').value = doc.date;
            document.getElementById('entry-narration').value = doc.narration;

            lineItems = doc.lineItems || [];
            displayLineItems();
        }

        function addLineItem() {
            const accountType = document.getElementById('line-account-type').value;
            const description = document.getElementById('line-description').value;
            const debit = parseFloat(document.getElementById('line-debit').value.replace(/,/g, '')) || 0;
            const credit = parseFloat(document.getElementById('line-credit').value.replace(/,/g, '')) || 0;

            if (debit > 0 && credit > 0) {
                alert("A journal line can only have a Debit OR a Credit, not both.");
                return;
            }

            if (!description.trim()) {
                alert("Please provide a description.");
                return;
            }

            if (debit > 0 || credit > 0) {
                lineItems.push({
                    account: accountType,
                    description: description,
                    debit: debit,
                    credit: credit
                });
                displayLineItems();
                
                document.getElementById('line-description').value = '';
                document.getElementById('line-debit').value = '';
                document.getElementById('line-credit').value = '';
            } else {
                alert('Please provide a debit or credit amount.');
            }
        }

        function removeLineItem(index) {
            lineItems.splice(index, 1);
            displayLineItems();
        }

        function displayLineItems() {
            const tbody = document.getElementById('journal-lines-body');
            tbody.innerHTML = '';
            let totalDebit = 0;
            let totalCredit = 0;

            lineItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.account}</td>
                    <td>${item.description}</td>
                    <td class="debit-column">${item.debit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="credit-column">${item.credit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="action-cell"><button onclick="window.removeLineItem(${index})">X</button></td>
                `;
                totalDebit += item.debit;
                totalCredit += item.credit;
            });

            document.getElementById('total-debit').textContent = totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-credit').textContent = totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        async function saveJournalEntry() {
            const docNumber = document.getElementById('je-no').value;
            const date = document.getElementById('entry-date').value;
            const narration = document.getElementById('entry-narration').value;
            const totalDebit = parseFloat(document.getElementById('total-debit').textContent.replace(/,/g, '')) || 0;
            const totalCredit = parseFloat(document.getElementById('total-credit').textContent.replace(/,/g, '')) || 0;

            if (!date || !narration) {
                alert("Please fill in Date and Narration.");
                return;
            }

            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                alert(`Journal Entry is unbalanced! Total Debit (${totalDebit.toLocaleString('en-US')}) must equal Total Credit (${totalCredit.toLocaleString('en-US')}).`);
                return;
            }

            if (lineItems.length === 0) {
                alert('Please add at least one line item.');
                return;
            }
            
            const newJournal = {
                number: docNumber,
                date: date,
                narration: narration,
                lineItems: lineItems,
                totalDebit: totalDebit,
                totalCredit: totalCredit,
                type: 'Journal Entry',
                timestamp: new Date().toISOString()
            };

            try {
                await setDoc(doc(db, "journalEntries", docNumber), newJournal);

                if (isEditing) {
                    const ledgerQuery = query(collection(db, "ledger"));
                    const ledgerSnapshot = await getDocs(ledgerQuery);
                    
                    for (const docSnap of ledgerSnapshot.docs) {
                        const ledgerEntry = docSnap.data();
                        if (ledgerEntry.doc_number === originalDocNumber) {
                            await deleteDoc(doc(db, "ledger", docSnap.id));
                        }
                    }
                }

                for (const item of lineItems) {
                    const ledgerId = `${docNumber}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    await setDoc(doc(db, "ledger", ledgerId), {
                        date: date,
                        description: `${item.description} (${narration})`,
                        accountType: item.account,
                        debit: item.debit,
                        credit: item.credit,
                        doc_number: docNumber,
                        timestamp: new Date().toISOString()
                    });
                }

                alert(isEditing ? 'Journal Entry updated successfully!' : 'Journal Entry saved and ledger updated!');
                window.location.href = 'documents.html';
            } catch (error) {
                console.error("Error saving journal entry:", error);
                alert("Error saving journal entry. Please try again.");
            }
        }

        async function deleteJournalEntry() {
            const docNumber = document.getElementById('je-no').value;
            
            if (!confirm(`Are you sure you want to delete Journal Entry ${docNumber}? This will remove all associated ledger lines.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, "journalEntries", docNumber));

                const ledgerQuery = query(collection(db, "ledger"));
                const ledgerSnapshot = await getDocs(ledgerQuery);
                
                for (const docSnap of ledgerSnapshot.docs) {
                    const ledgerEntry = docSnap.data();
                    if (ledgerEntry.doc_number === docNumber) {
                        await deleteDoc(doc(db, "ledger", docSnap.id));
                    }
                }

                alert('Journal Entry and all associated ledger lines deleted successfully.');
                window.location.href = 'documents.html';
            } catch (error) {
                console.error("Error deleting journal entry:", error);
                alert("Error deleting journal entry. Please try again.");
            }
        }
        
        function generatePDF() {
            const docNumber = document.getElementById('je-no').value;
            const date = document.getElementById('entry-date').value;
            const narration = document.getElementById('entry-narration').value;

            let pdfContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2 style="text-align: center; color: #003366;">General Journal Entry</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: #003366;">(BET) Bilal Ehtasham Traders</h3>
                        <p>Deals in all kinds of Cotton and Polyester Yarn</p>
                    </div>
                    <p><strong>Entry Number:</strong> ${docNumber}</p>
                    <p><strong>Date:</strong> ${date}</p>
                    <p><strong>Narration:</strong> ${narration}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Account</th>
                                <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Description</th>
                                <th style="border: 1px solid #ccc; padding: 10px; text-align: right;">Debit (Rs.)</th>
                                <th style="border: 1px solid #ccc; padding: 10px; text-align: right;">Credit (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            lineItems.forEach(item => {
                pdfContent += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 10px;">${item.account}</td>
                        <td style="border: 1px solid #ccc; padding: 10px;">${item.description}</td>
                        <td style="border: 1px solid #ccc; padding: 10px; text-align: right;">${item.debit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td style="border: 1px solid #ccc; padding: 10px; text-align: right;">${item.credit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });

            const totalDebit = document.getElementById('total-debit').textContent;
            const totalCredit = document.getElementById('total-credit').textContent;

            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #e6e6ff; font-weight: bold;">
                                <td colspan="2" style="border: 1px solid #ccc; padding: 10px;">TOTAL</td>
                                <td style="border: 1px solid #ccc; padding: 10px; text-align: right;">${totalDebit}</td>
                                <td style="border: 1px solid #ccc; padding: 10px; text-align: right;">${totalCredit}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');

                if (editId) {
                    const docRef = doc(db, "journalEntries", editId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        await populateForm(docSnap.data());
                        isEditing = true;
                        originalDocNumber = editId;
                        document.getElementById('deleteButton').style.display = 'inline-block';
                    }
                } else {
                    const nextNumber = await getNextJENumber();
                    document.getElementById('je-no').value = nextNumber;
                    document.getElementById('entry-date').value = new Date().toLocaleDateString('en-GB');
                    document.getElementById('deleteButton').style.display = 'none';
                }

                document.getElementById('line-debit').addEventListener('input', formatInput);
                document.getElementById('line-credit').addEventListener('input', formatInput);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error("Error initializing:", error);
                document.getElementById('loading').innerHTML = 'Error loading. Please refresh the page.';
            }
        });

        window.addLineItem = addLineItem;
        window.removeLineItem = removeLineItem;
        window.saveJournalEntry = saveJournalEntry;
        window.deleteJournalEntry = deleteJournalEntry;
        window.generatePDF = generatePDF;
    </script>
</body>
</html>