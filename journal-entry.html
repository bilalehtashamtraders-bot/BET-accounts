<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Journal - Bilal Ehtasham Traders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        .report-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #003366;
        }
        .business-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .business-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .business-info h2 {
            color: #003366;
        }
        .controls {
            margin-bottom: 20px;
            display: flex; /* Use flex to align buttons */
            justify-content: flex-end;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-button {
            background-color: #cc0000 !important;
        }
        .form-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .form-row input, .form-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-je-no {
            flex: 0.5; /* Give Journal Number less space */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .debit-column, .credit-column {
            text-align: right;
        }
        .total-row td {
            font-weight: bold;
            background-color: #e6e6ff;
        }
        .action-cell {
            text-align: center;
            width: 50px;
        }
        .action-cell button {
            padding: 4px 8px;
            background-color: #555;
            font-size: 12px;
        }

        /* --- Mobile-Specific Styling --- */
        @media (max-width: 600px) {
            body {
                margin: 10px;
            }
            .report-container {
                padding: 10px;
            }
            .form-row {
                flex-direction: column;
                gap: 5px;
            }
            .form-row input, .form-row select {
                width: 100%;
            }
            .input-je-no {
                flex: 1;
            }
            table, th, td {
                font-size: 10px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <script src="data.js"></script>
    <div class="report-container">
        <div class="header">
            <h1>General Journal</h1>
        </div>
        <div class="business-info">
            <h2 style="color: #003366;">(BET) Bilal Ehtasham Traders</h2>
            <p>Deals in all kinds of Cotton and Polyester Yarn</p>
            <p>Email: bilalehtashamtraders@gmail.com</p>
            <p>Cell: (+92)-324-2479096</p>
        </div>
        
        <div class="controls">
            <button onclick="saveJournalEntry()">Save/Update Entry</button>
            <button onclick="deleteJournalEntry()" id="deleteButton" class="delete-button" style="display: none;">Delete Entry</button>
            <button onclick="generatePDF()">Generate PDF</button>
        </div>

        <div class="form-container">
            <h3>Journal Entry Details</h3>
            <div class="form-row">
                <input type="text" id="je-no" class="input-je-no" placeholder="JE No." readonly>
                <input type="text" id="entry-date" placeholder="Date">
                <input type="text" id="entry-narration" placeholder="Narration/Summary">
            </div>

            <h4>Line Items</h4>
            <div class="form-row">
                <select id="line-account-type">
                    <option value="Cash">Cash</option>
                    <option value="Revenue">Revenue</option>
                    <option value="Expense">Expense</option>
                    <option value="Accounts Receivable">Accounts Receivable</option>
                    <option value="Accounts Payable">Accounts Payable</option>
                    </select>
                <input type="text" id="line-description" placeholder="Description/Reference">
                <input type="text" id="line-debit" class="debit-input" placeholder="Debit (Rs.)">
                <input type="text" id="line-credit" class="credit-input" placeholder="Credit (Rs.)">
            </div>
            <button onclick="addLineItem()">Add Line</button>
        </div>
        
        <table id="journal-entries-table">
            <thead>
                <tr>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Debit (Rs.)</th>
                    <th>Credit (Rs.)</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody id="journal-lines-body">
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2">TOTAL</td>
                    <td id="total-debit" class="debit-column">0.00</td>
                    <td id="total-credit" class="credit-column">0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        let isEditing = false;
        let originalDocNumber = null;
        let lineItems = []; // Array to hold current line items before saving

        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: loadData() should load 'documents' and 'ledger' from data.js
            // loadData(); 
            
            const docToEdit = JSON.parse(localStorage.getItem('docToEdit'));
            if (docToEdit) {
                populateForm(docToEdit);
                isEditing = true;
                originalDocNumber = docToEdit.number;
                localStorage.removeItem('docToEdit');
                document.getElementById('deleteButton').style.display = 'inline-block';
            } else {
                // document.getElementById('je-no').value = 'JE-' + (++lastJournalEntryNumber); 
                document.getElementById('entry-date').value = new Date().toLocaleDateString('en-GB');
                document.getElementById('deleteButton').style.display = 'none';
            }

            // Attach event listeners for input formatting
            document.getElementById('line-debit').addEventListener('input', formatInput);
            document.getElementById('line-credit').addEventListener('input', formatInput);
        });

        function formatInput(event) {
            const input = event.target;
            let value = input.value.replace(/[^0-9.]/g, ''); 
            
            if (value !== "") {
                // Format with 2 decimal places for amount
                value = parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            input.value = value;
        }

        function populateForm(doc) {
            document.getElementById('je-no').value = doc.number;
            document.getElementById('entry-date').value = doc.date;
            document.getElementById('entry-narration').value = doc.narration;

            // Load the line items from the saved document structure
            lineItems = doc.lineItems || [];
            displayLineItems();
        }

        function addLineItem() {
            const accountType = document.getElementById('line-account-type').value;
            const description = document.getElementById('line-description').value;
            // Strip commas for internal storage
            const debit = parseFloat(document.getElementById('line-debit').value.replace(/,/g, '')) || 0;
            const credit = parseFloat(document.getElementById('line-credit').value.replace(/,/g, '')) || 0;

            if (debit > 0 && credit > 0) {
                alert("A journal line can only have a Debit OR a Credit, not both.");
                return;
            }

            if (debit > 0 || credit > 0) {
                lineItems.push({
                    account: accountType,
                    description: description,
                    debit: debit,
                    credit: credit
                });
                displayLineItems();
                
                // Clear inputs after adding
                document.getElementById('line-description').value = '';
                document.getElementById('line-debit').value = '';
                document.getElementById('line-credit').value = '';
            } else {
                alert('Please provide a debit or credit amount.');
            }
        }

        function removeLineItem(index) {
            lineItems.splice(index, 1);
            displayLineItems();
        }

        function displayLineItems() {
            const tbody = document.getElementById('journal-lines-body');
            tbody.innerHTML = '';
            let totalDebit = 0;
            let totalCredit = 0;

            lineItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.account}</td>
                    <td>${item.description}</td>
                    <td class="debit-column">${item.debit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="credit-column">${item.credit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="action-cell"><button onclick="removeLineItem(${index})">X</button></td>
                `;
                totalDebit += item.debit;
                totalCredit += item.credit;
            });

            document.getElementById('total-debit').textContent = totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-credit').textContent = totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function saveJournalEntry() {
            const docNumber = document.getElementById('je-no').value;
            const date = document.getElementById('entry-date').value;
            const narration = document.getElementById('entry-narration').value;
            const totalDebit = parseFloat(document.getElementById('total-debit').textContent.replace(/,/g, '')) || 0;
            const totalCredit = parseFloat(document.getElementById('total-credit').textContent.replace(/,/g, '')) || 0;

            if (totalDebit !== totalCredit) {
                alert(`Journal Entry is unbalanced! Total Debit (${totalDebit.toLocaleString('en-US')}) must equal Total Credit (${totalCredit.toLocaleString('en-US')}).`);
                return;
            }

            if (lineItems.length === 0) {
                alert('Please add at least one line item.');
                return;
            }
            
            const newJournal = {
                number: docNumber,
                date: date,
                narration: narration,
                lineItems: lineItems, // The full array of lines
                totalDebit: totalDebit,
                totalCredit: totalCredit,
                type: 'Journal Entry'
            };

            if (isEditing) {
                // 1. Update the document object
                const docIndex = documents.findIndex(doc => doc.number === originalDocNumber);
                if (docIndex > -1) {
                    documents[docIndex] = newJournal;
                }

                // 2. Remove old ledger entries for this JE number
                ledger = ledger.filter(entry => entry.doc_number !== originalDocNumber);
                
                // 3. Add new ledger entries
                lineItems.forEach(item => {
                    ledger.push({
                        date: date,
                        description: `${item.description} (${narration})`,
                        accountType: item.account,
                        debit: item.debit,
                        credit: item.credit,
                        doc_number: docNumber // Use the new/current JE number
                    });
                });

                alert('Journal Entry updated successfully!');
            } else {
                // NEW ENTRY
                documents.push(newJournal);

                // Add ledger entries for all lines
                lineItems.forEach(item => {
                    ledger.push({
                        date: date,
                        description: `${item.description} (${narration})`,
                        accountType: item.account,
                        debit: item.debit,
                        credit: item.credit,
                        doc_number: docNumber
                    });
                });
                alert('Journal Entry saved and ledger updated!');
            }
            // NOTE: Uncomment saveData() when integrating with data.js
            // saveData();
        }

        function deleteJournalEntry() {
            if (confirm(`Are you sure you want to delete Journal Entry number ${document.getElementById('je-no').value}? This will remove all associated ledger lines.`)) {
                const docNumber = document.getElementById('je-no').value;

                // 1. Delete from documents
                const docIndex = documents.findIndex(doc => doc.number === docNumber);
                if (docIndex > -1) {
                    documents.splice(docIndex, 1);
                }

                // 2. Delete ALL associated ledger entries (using filter)
                ledger = ledger.filter(entry => entry.doc_number !== docNumber);
                
                // NOTE: Uncomment saveData() when integrating with data.js
                // saveData();
                alert('Journal Entry and all associated ledger lines deleted successfully. Redirecting to new entry page.');
                window.location.reload(); 
            }
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text(`Journal Entry #${document.getElementById('je-no').value}`, 14, 15);
            doc.text(`Date: ${document.getElementById('entry-date').value}`, 14, 22);
            doc.text(`Narration: ${document.getElementById('entry-narration').value}`, 14, 29);

            doc.autoTable({
                html: '#journal-entries-table',
                startY: 35,
                didParseCell: function(data) {
                    if (data.cell.text[0] === 'TOTAL') {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            doc.save(`Journal-Entry-#${document.getElementById('je-no').value}.pdf`);
        }
    </script>
</body>
</html>
